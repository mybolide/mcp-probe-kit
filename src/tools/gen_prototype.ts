import { parseArgs, getString } from "../utils/parseArgs.js";
import { okStructured } from "../lib/response.js";
import { renderGuidanceHeader } from "../lib/guidance.js";
import type { GenPrototypeReport } from "../schemas/output/product-design-tools.js";

/**
 * gen_prototype - ç”ŸæˆåŸå‹è®¾è®¡æ–‡æ¡£æŒ‡å¯¼
 * 
 * è¿”å›åŸå‹è®¾è®¡æ–‡æ¡£æ¨¡æ¿å’Œåˆ›å»ºæŒ‡å¯¼ï¼Œç”± AI æ ¹æ® PRD æˆ–åŠŸèƒ½æè¿°å¡«å……å†…å®¹å¹¶åˆ›å»ºæ–‡ä»¶
 */

export async function genPrototype(args: any) {
  try {
    // ä½¿ç”¨æ™ºèƒ½å‚æ•°è§£æ
    const parsedArgs = parseArgs<{
      prd_path?: string;
      description?: string;
      docs_dir?: string;
    }>(args, {
      defaultValues: {
        prd_path: "",
        description: "",
        docs_dir: "docs",
      },
      primaryField: "description",
      fieldAliases: {
        prd_path: ["prd", "prd_file"],
        description: ["desc", "æè¿°"],
        docs_dir: ["dir", "ç›®å½•"],
      },
    });

    const prdPath = getString(parsedArgs.prd_path);
    const description = getString(parsedArgs.description);
    const docsDir = getString(parsedArgs.docs_dir) || "docs";

    if (!prdPath && !description) {
      const errorData: GenPrototypeReport = {
        summary: "åŸå‹è®¾è®¡ç”Ÿæˆå¤±è´¥",
        docsDir,
        source: {},
        indexPath: `${docsDir}/prototype/prototype-index.md`,
        pages: [],
        content: "",
      };
      return okStructured(
        "âŒ ç¼ºå°‘å¿…éœ€å‚æ•°ï¼šprd_path æˆ– description è‡³å°‘æä¾›ä¸€ä¸ª",
        errorData,
        {
          schema: (await import("../schemas/output/product-design-tools.js")).GenPrototypeSchema,
        }
      );
    }

    const header = renderGuidanceHeader({
      tool: "gen_prototype",
      goal: "ç”ŸæˆåŸå‹è®¾è®¡æ–‡æ¡£ï¼ˆç´¢å¼• + é¡µé¢åŸå‹ï¼‰ã€‚",
      tasks: [
        prdPath ? `è¯»å– ${prdPath} å¹¶æå–é¡µé¢æ¸…å•` : "æ ¹æ®åŠŸèƒ½æè¿°è®¾è®¡é¡µé¢æ¸…å•",
        `ä¸ºæ¯ä¸ªé¡µé¢ç”ŸæˆåŸå‹æ–‡æ¡£å¹¶è½ç›˜åˆ° ${docsDir}/prototype/`,
      ],
      outputs: ["åŸå‹ç´¢å¼• + é¡µé¢åŸå‹æ–‡æ¡£ï¼ˆä¸¥æ ¼æŒ‰æ¨¡æ¿ç»“æ„ï¼‰"],
    });

    const guidanceText = `${header}# ğŸ¨ ç”ŸæˆåŸå‹è®¾è®¡æ–‡æ¡£æŒ‡å¯¼

## ğŸ“‹ è¾“å…¥ä¿¡æ¯

- **PRD æ–‡æ¡£è·¯å¾„**: ${prdPath || "æœªæä¾›"}
- **åŠŸèƒ½æè¿°**: ${description || "ä» PRD ä¸­æå–"}
- **æ–‡æ¡£ç›®å½•**: ${docsDir}

---

## ğŸ¯ ä»»åŠ¡è¯´æ˜

${prdPath ? `è¯·è¯»å– PRD æ–‡æ¡£ \`${prdPath}\`ï¼Œä»ä¸­æå–é¡µé¢æ¸…å•ï¼Œç„¶åä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºåŸå‹è®¾è®¡æ–‡æ¡£ã€‚` : `è¯·æ ¹æ®åŠŸèƒ½æè¿°ï¼Œè®¾è®¡é¡µé¢æ¸…å•ï¼Œç„¶åä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºåŸå‹è®¾è®¡æ–‡æ¡£ã€‚`}

---

## ğŸ“ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1: æå–/è®¾è®¡é¡µé¢æ¸…å•

${prdPath ? `
**ä» PRD ä¸­æå–é¡µé¢æ¸…å•**:
1. è¯»å– \`${prdPath}\` æ–‡ä»¶
2. æ‰¾åˆ° "## 5. é¡µé¢æ¸…å•" ç« èŠ‚
3. æå–è¡¨æ ¼ä¸­çš„æ‰€æœ‰é¡µé¢ä¿¡æ¯ï¼ˆé¡µé¢åç§°ã€è·¯å¾„ã€ç±»å‹ã€è¯´æ˜ï¼‰
` : `
**æ ¹æ®åŠŸèƒ½æè¿°è®¾è®¡é¡µé¢æ¸…å•**:
1. åˆ†æåŠŸèƒ½æè¿°
2. è®¾è®¡è‡³å°‘åŒ…å«ä»¥ä¸‹é¡µé¢ï¼š
   - é¦–é¡µï¼ˆ/ï¼‰- äº§å“ä»‹ç»å’Œå¯¼èˆªå…¥å£
   - æ ¸å¿ƒåŠŸèƒ½é¡µï¼ˆ/featureï¼‰- ä¸»è¦åŠŸèƒ½å±•ç¤º
   - å…¶ä»–å¿…è¦é¡µé¢
`}

### æ­¥éª¤ 2: åˆ›å»ºåŸå‹ç´¢å¼•æ–‡æ¡£

åˆ›å»ºæ–‡ä»¶ \`${docsDir}/prototype/prototype-index.md\`ï¼š

\`\`\`markdown
# åŸå‹è®¾è®¡ç´¢å¼•

> ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
> å·¥å…·ç‰ˆæœ¬ï¼šmcp-probe-kit v2.3.0

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯åŸå‹è®¾è®¡çš„ç´¢å¼•æ–‡ä»¶ï¼Œåˆ—å‡ºäº†æ‰€æœ‰é¡µé¢çš„åŸå‹æ–‡æ¡£ã€‚

## é¡µé¢æ¸…å•

å…± [N] ä¸ªé¡µé¢ï¼š

- [é¡µé¢1åç§°](page-é¡µé¢1åç§°.md) - é¡µé¢1è¯´æ˜
- [é¡µé¢2åç§°](page-é¡µé¢2åç§°.md) - é¡µé¢2è¯´æ˜
- [é¡µé¢3åç§°](page-é¡µé¢3åç§°.md) - é¡µé¢3è¯´æ˜

---

## é¡µé¢å¯¼èˆªæµç¨‹

**æ ¹æ®é¡µé¢åŠŸèƒ½è®¾è®¡å¯¼èˆªæµç¨‹ï¼š**

- é¦–é¡µ â†’ åŠŸèƒ½é¡µ â†’ è¯¦æƒ…é¡µ
- [æ ¹æ®å®é™…é¡µé¢è®¾è®¡å¯¼èˆªæµç¨‹]

---

## ä½¿ç”¨è¯´æ˜

1. ç‚¹å‡»ä¸Šæ–¹çš„é¡µé¢é“¾æ¥æŸ¥çœ‹å¯¹åº”çš„åŸå‹æ–‡æ¡£
2. æ¯ä¸ªåŸå‹æ–‡æ¡£åŒ…å«é¡µé¢ç»“æ„ã€äº¤äº’è¯´æ˜ã€å…ƒç´ æ¸…å•
3. å®ŒæˆåŸå‹è®¾è®¡åï¼Œå¯ä»¥ä½¿ç”¨ \`start_ui\` å·¥å…·ç”Ÿæˆ HTML åŸå‹

---

## ä¸‹ä¸€æ­¥

- [ ] å®Œå–„æ¯ä¸ªé¡µé¢çš„åŸå‹æ–‡æ¡£
- [ ] ä½¿ç”¨ \`ui_design_system\` å·¥å…·ç”Ÿæˆè®¾è®¡ç³»ç»Ÿ
- [ ] ä½¿ç”¨ \`start_ui\` å·¥å…·ç”Ÿæˆ HTML å¯äº¤äº’åŸå‹
- [ ] ä¸å›¢é˜Ÿè¯„å®¡åŸå‹è®¾è®¡
\`\`\`

### æ­¥éª¤ 3: ä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºåŸå‹æ–‡æ¡£

ä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºæ–‡ä»¶ \`${docsDir}/prototype/page-[é¡µé¢åç§°].md\`ï¼š

\`\`\`markdown
# é¡µé¢åŸå‹ - [é¡µé¢åç§°]

> ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
> å·¥å…·ç‰ˆæœ¬ï¼šmcp-probe-kit v2.3.0

## é¡µé¢ä¿¡æ¯

- **é¡µé¢åç§°**: [é¡µé¢åç§°]
- **é¡µé¢è·¯å¾„**: [é¡µé¢è·¯å¾„]
- **é¡µé¢ç±»å‹**: [é¡µé¢ç±»å‹]
- **é¡µé¢è¯´æ˜**: [é¡µé¢è¯´æ˜]

---

## é¡µé¢ç»“æ„

### Headerï¼ˆé¡µå¤´ï¼‰

**è®¾è®¡é¡µå¤´åŒºåŸŸï¼š**
- Logo
- å¯¼èˆªèœå•
- ç”¨æˆ·ä¿¡æ¯/ç™»å½•æŒ‰é’®

### Main Contentï¼ˆä¸»å†…å®¹åŒºï¼‰

**æ ¹æ®é¡µé¢åŠŸèƒ½è®¾è®¡ä¸»å†…å®¹åŒºï¼š**

#### Section 1
- å…ƒç´  1
- å…ƒç´  2
- å…ƒç´  3

#### Section 2
- å…ƒç´  1
- å…ƒç´  2

### Footerï¼ˆé¡µè„šï¼‰

**è®¾è®¡é¡µè„šåŒºåŸŸï¼š**
- ç‰ˆæƒä¿¡æ¯
- è”ç³»æ–¹å¼
- ç›¸å…³é“¾æ¥

---

## äº¤äº’è¯´æ˜

**æè¿°é¡µé¢çš„äº¤äº’è¡Œä¸ºï¼š**

1. **äº¤äº’ 1**
   - è§¦å‘æ¡ä»¶ï¼š[ç”¨æˆ·æ“ä½œ]
   - è¡Œä¸ºï¼š[ç³»ç»Ÿå“åº”]
   - ç›®æ ‡ï¼š[è·³è½¬æˆ–çŠ¶æ€å˜åŒ–]

2. **äº¤äº’ 2**
   - è§¦å‘æ¡ä»¶ï¼š[ç”¨æˆ·æ“ä½œ]
   - è¡Œä¸ºï¼š[ç³»ç»Ÿå“åº”]
   - ç›®æ ‡ï¼š[è·³è½¬æˆ–çŠ¶æ€å˜åŒ–]

---

## é¡µé¢å…ƒç´ æ¸…å•

**åˆ—å‡ºé¡µé¢æ‰€éœ€çš„æ‰€æœ‰ UI å…ƒç´ ï¼š**

- [ ] å…ƒç´  1ï¼š[æè¿°]
- [ ] å…ƒç´  2ï¼š[æè¿°]
- [ ] å…ƒç´  3ï¼š[æè¿°]
- [ ] å…ƒç´  4ï¼š[æè¿°]

---

## è®¾è®¡å»ºè®®

**æä¾›è®¾è®¡å»ºè®®ï¼š**

- **å¸ƒå±€å»ºè®®**: [å“åº”å¼å¸ƒå±€ã€æ …æ ¼ç³»ç»Ÿç­‰]
- **è§†è§‰å»ºè®®**: [é¢œè‰²ã€å­—ä½“ã€é—´è·ç­‰]
- **äº¤äº’å»ºè®®**: [åŠ¨ç”»ã€åé¦ˆã€åŠ è½½çŠ¶æ€ç­‰]
\`\`\`

---

## ğŸ“Œ å¡«å……æŒ‡å—

### é¡µé¢ç»“æ„
- æ ¹æ®é¡µé¢åŠŸèƒ½è®¾è®¡åˆç†çš„å¸ƒå±€ç»“æ„
- åŒ…å« Headerã€Main Contentã€Footer ä¸‰ä¸ªä¸»è¦åŒºåŸŸ
- Main Content å¯ä»¥åˆ†ä¸ºå¤šä¸ª Section

### äº¤äº’è¯´æ˜
- æè¿°ç”¨æˆ·åœ¨é¡µé¢ä¸Šçš„æ‰€æœ‰äº¤äº’è¡Œä¸º
- åŒ…æ‹¬ç‚¹å‡»ã€è¾“å…¥ã€æ»šåŠ¨ç­‰æ“ä½œ
- è¯´æ˜æ¯ä¸ªäº¤äº’çš„è§¦å‘æ¡ä»¶ã€ç³»ç»Ÿå“åº”å’Œç›®æ ‡

### é¡µé¢å…ƒç´ æ¸…å•
- åˆ—å‡ºé¡µé¢æ‰€éœ€çš„æ‰€æœ‰ UI å…ƒç´ 
- åŒ…æ‹¬æŒ‰é’®ã€è¾“å…¥æ¡†ã€å¡ç‰‡ã€åˆ—è¡¨ç­‰
- ä¸ºæ¯ä¸ªå…ƒç´ æä¾›ç®€è¦æè¿°

### è®¾è®¡å»ºè®®
- æä¾›å¸ƒå±€ã€è§†è§‰ã€äº¤äº’æ–¹é¢çš„è®¾è®¡å»ºè®®
- è€ƒè™‘å“åº”å¼è®¾è®¡å’Œç”¨æˆ·ä½“éªŒ
- å‚è€ƒè®¾è®¡ç³»ç»Ÿè§„èŒƒ

---

## âœ… å®Œæˆå

æ‰€æœ‰åŸå‹æ–‡æ¡£åº”è¯¥å·²ç»åˆ›å»ºåœ¨ \`${docsDir}/prototype/\` ç›®å½•ä¸‹ï¼š
- \`prototype-index.md\` - åŸå‹ç´¢å¼•
- \`page-*.md\` - å„é¡µé¢åŸå‹æ–‡æ¡£

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. ä½¿ç”¨ \`ui_design_system\` å·¥å…·ç”Ÿæˆè®¾è®¡ç³»ç»Ÿ
2. ä½¿ç”¨ \`start_ui\` å·¥å…·ç”Ÿæˆ HTML å¯äº¤äº’åŸå‹
3. æˆ–ä½¿ç”¨ \`start_product\` å·¥å…·æ‰§è¡Œå®Œæ•´çš„äº§å“è®¾è®¡å·¥ä½œæµ

---

ğŸ’¡ **æç¤º**: è¿™æ˜¯ä¸€ä¸ªæŒ‡å¯¼æ–‡æ¡£ï¼ŒAI éœ€è¦æ ¹æ® PRD æˆ–åŠŸèƒ½æè¿°æ™ºèƒ½å¡«å……æ‰€æœ‰å†…å®¹å¹¶åˆ›å»ºå®é™…çš„åŸå‹æ–‡ä»¶ã€‚
`;

    const structuredData: GenPrototypeReport = {
      summary: "ç”ŸæˆåŸå‹è®¾è®¡æ–‡æ¡£",
      docsDir,
      source: {
        ...(prdPath ? { prdPath } : {}),
        ...(description ? { description } : {}),
      },
      indexPath: `${docsDir}/prototype/prototype-index.md`,
      pages: [],
      content: "",
    };

    return okStructured(guidanceText, structuredData, {
      schema: (await import("../schemas/output/product-design-tools.js")).GenPrototypeSchema,
    });
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    const errorData: GenPrototypeReport = {
      summary: "åŸå‹è®¾è®¡ç”Ÿæˆå¤±è´¥",
      docsDir: "docs",
      source: {},
      indexPath: "docs/prototype/prototype-index.md",
      pages: [],
      content: "",
    };
    return okStructured(`âŒ ç”ŸæˆåŸå‹è®¾è®¡æŒ‡å¯¼å¤±è´¥: ${errorMessage}`, errorData, {
      schema: (await import("../schemas/output/product-design-tools.js")).GenPrototypeSchema,
    });
  }
}
