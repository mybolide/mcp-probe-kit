import { parseArgs, getString } from "../utils/parseArgs.js";

/**
 * start_review æ™ºèƒ½ç¼–æ’å·¥å…·
 * 
 * åœºæ™¯ï¼šä»£ç ä½“æ£€
 * ç¼–æ’ï¼š[æ£€æŸ¥ä¸Šä¸‹æ–‡] â†’ code_review â†’ security_scan â†’ perf
 */

const PROMPT_TEMPLATE = `# ğŸ” ä»£ç ä½“æ£€ç¼–æ’æŒ‡å—

## ğŸ¯ ç›®æ ‡

å¯¹ä»¥ä¸‹ä»£ç è¿›è¡Œå…¨é¢ä½“æ£€ï¼š

\`\`\`{language}
{code}
\`\`\`

---

## ğŸ“‹ æ­¥éª¤ 0: é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰

**æ“ä½œ**:
1. æ£€æŸ¥ \`docs/project-context.md\` æ˜¯å¦å­˜åœ¨
2. **å¦‚æœä¸å­˜åœ¨**ï¼š
   - è°ƒç”¨ \`init_project_context\` å·¥å…·
   - ç­‰å¾…ç”Ÿæˆå®Œæˆ
3. **è¯»å–** \`docs/project-context.md\` å†…å®¹
4. äº†è§£é¡¹ç›®çš„ç¼–ç è§„èŒƒã€æŠ€æœ¯æ ˆ
5. åç»­å®¡æŸ¥è¦å‚è€ƒé¡¹ç›®è§„èŒƒ

---

## ğŸ“ æ­¥éª¤ 1: ä»£ç è´¨é‡å®¡æŸ¥

**è°ƒç”¨å·¥å…·**: \`code_review\`

**å‚æ•°**:
\`\`\`json
{
  "code": "[å¾…å®¡æŸ¥ä»£ç ]",
  "focus": "quality"
}
\`\`\`

**å®¡æŸ¥è¦ç‚¹**:
- ä»£ç å¯è¯»æ€§
- å‘½åè§„èŒƒ
- ä»£ç ç»“æ„
- æœ€ä½³å®è·µ
- æ½œåœ¨ Bug

**äº§å‡º**: è´¨é‡é—®é¢˜æ¸…å•

---

## ğŸ”’ æ­¥éª¤ 2: å®‰å…¨æ¼æ´æ‰«æ

**è°ƒç”¨å·¥å…·**: \`security_scan\`

**å‚æ•°**:
\`\`\`json
{
  "code": "[å¾…å®¡æŸ¥ä»£ç ]",
  "scan_type": "all"
}
\`\`\`

**æ‰«æè¦ç‚¹**:
- æ³¨å…¥æ¼æ´ï¼ˆSQL/XSS/å‘½ä»¤æ³¨å…¥ï¼‰
- è®¤è¯æˆæƒé—®é¢˜
- åŠ å¯†å®‰å…¨
- æ•æ„Ÿæ•°æ®æ³„éœ²

**äº§å‡º**: å®‰å…¨æ¼æ´æŠ¥å‘Š

---

## âš¡ æ­¥éª¤ 3: æ€§èƒ½åˆ†æ

**è°ƒç”¨å·¥å…·**: \`perf\`

**å‚æ•°**:
\`\`\`json
{
  "code": "[å¾…å®¡æŸ¥ä»£ç ]",
  "type": "all"
}
\`\`\`

**åˆ†æè¦ç‚¹**:
- ç®—æ³•å¤æ‚åº¦
- å†…å­˜ä½¿ç”¨
- æ•°æ®åº“æŸ¥è¯¢
- æ¸²æŸ“æ€§èƒ½ï¼ˆå¦‚é€‚ç”¨ï¼‰

**äº§å‡º**: æ€§èƒ½ä¼˜åŒ–å»ºè®®

---

## âœ… å®Œæˆæ£€æŸ¥

- [ ] é¡¹ç›®ä¸Šä¸‹æ–‡å·²è¯»å–
- [ ] ä»£ç è´¨é‡å·²å®¡æŸ¥
- [ ] å®‰å…¨æ¼æ´å·²æ‰«æ
- [ ] æ€§èƒ½å·²åˆ†æ

---

## ğŸ“Š ç»¼åˆæŠ¥å‘Šæ¨¡æ¿

å®Œæˆåï¼Œç”Ÿæˆç»¼åˆæŠ¥å‘Šï¼š

### ä»£ç ä½“æ£€æŠ¥å‘Š

#### ğŸ“ˆ æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | é—®é¢˜æ•° |
|------|------|--------|
| ä»£ç è´¨é‡ | ?/10 | X ä¸ª |
| å®‰å…¨æ€§ | ?/10 | X ä¸ª |
| æ€§èƒ½ | ?/10 | X ä¸ª |
| **ç»¼åˆ** | ?/10 | |

#### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰
[åˆ—å‡ºä¸¥é‡é—®é¢˜]

#### ğŸŸ¡ ä¸€èˆ¬é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰
[åˆ—å‡ºä¸€èˆ¬é—®é¢˜]

#### ğŸŸ¢ ä¼˜åŒ–å»ºè®®
[åˆ—å‡ºä¼˜åŒ–å»ºè®®]

#### ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§
1. [æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜]
2. [æ¬¡ä¼˜å…ˆçº§é—®é¢˜]
...

---

*ç¼–æ’å·¥å…·: MCP Probe Kit - start_review*
`;

export async function startReview(args: any) {
  try {
    // æ™ºèƒ½å‚æ•°è§£æï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€è¾“å…¥
    const parsedArgs = parseArgs<{
      code?: string;
      language?: string;
    }>(args, {
      defaultValues: {
        code: "",
        language: "auto",
      },
      primaryField: "code", // çº¯æ–‡æœ¬è¾“å…¥é»˜è®¤æ˜ å°„åˆ° code å­—æ®µ
      fieldAliases: {
        code: ["source", "src", "ä»£ç ", "content"],
        language: ["lang", "è¯­è¨€", "ç¼–ç¨‹è¯­è¨€"],
      },
    });

    const code = getString(parsedArgs.code);
    const language = getString(parsedArgs.language) || "auto";

    if (!code) {
      throw new Error("ç¼ºå°‘å¿…å¡«å‚æ•°: codeï¼ˆéœ€è¦å®¡æŸ¥çš„ä»£ç ï¼‰");
    }

    const guide = PROMPT_TEMPLATE
      .replace(/{code}/g, code)
      .replace(/{language}/g, language);

    return {
      content: [{ type: "text", text: guide }],
    };
  } catch (error) {
    const errorMsg = error instanceof Error ? error.message : String(error);
    return {
      content: [{ type: "text", text: `âŒ ç¼–æ’æ‰§è¡Œå¤±è´¥: ${errorMsg}` }],
      isError: true,
    };
  }
}
