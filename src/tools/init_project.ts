import { parseArgs, getString } from "../utils/parseArgs.js";

// init_project å·¥å…·å®ç°
export async function initProject(args: any) {
  try {
    // æ™ºèƒ½å‚æ•°è§£æï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€è¾“å…¥
    const parsedArgs = parseArgs<{
      input?: string;
      project_name?: string;
    }>(args, {
      defaultValues: {
        input: "",
        project_name: "æ–°é¡¹ç›®",
      },
      primaryField: "input", // çº¯æ–‡æœ¬è¾“å…¥é»˜è®¤æ˜ å°„åˆ° input å­—æ®µ
      fieldAliases: {
        input: ["requirement", "description", "éœ€æ±‚", "é¡¹ç›®éœ€æ±‚"],
        project_name: ["name", "project", "é¡¹ç›®å", "é¡¹ç›®åç§°"],
      },
    });
    
    const input = getString(parsedArgs.input);
    const projectName = getString(parsedArgs.project_name) || "æ–°é¡¹ç›®";
    const featureSlug = projectName.toLowerCase().replace(/\s+/g, '-');

    const message = `ä½ éœ€è¦æŒ‰ç…§ Spec-Driven Developmentï¼ˆè§„èŒƒé©±åŠ¨å¼€å‘ï¼‰çš„æ–¹å¼åˆå§‹åŒ–é¡¹ç›®ï¼Œå‚è€ƒ https://github.com/github/spec-kit çš„å·¥ä½œæµç¨‹ã€‚

ğŸ“‹ **é¡¹ç›®éœ€æ±‚**ï¼š
${input}

ğŸ¯ **åˆå§‹åŒ–æ­¥éª¤**ï¼š

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºé¡¹ç›®åŸºç¡€ç»“æ„**
åœ¨å½“å‰å·¥ä½œåŒºåˆ›å»ºä»¥ä¸‹ç›®å½•å’Œæ–‡ä»¶ï¼š

\`\`\`
.
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ project-context.md           # é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆæŠ€æœ¯æ ˆã€æ¶æ„ã€è§„èŒƒï¼‰
â”‚   â”œâ”€â”€ constitution.md              # é¡¹ç›®å®ªæ³•ï¼ˆæ ¸å¿ƒåŸåˆ™å’Œçº¦æŸï¼‰
â”‚   â””â”€â”€ specs/
â”‚       â””â”€â”€ ${featureSlug}/
â”‚           â”œâ”€â”€ requirements.md      # éœ€æ±‚æ–‡æ¡£ï¼ˆEARS æ ¼å¼ï¼‰
â”‚           â”œâ”€â”€ design.md            # è®¾è®¡æ–‡æ¡£
â”‚           â”œâ”€â”€ tasks.md             # ä»»åŠ¡åˆ†è§£
â”‚           â””â”€â”€ research.md          # æŠ€æœ¯è°ƒç ”
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ check-prerequisites.sh
â”‚   â””â”€â”€ setup.sh
â””â”€â”€ src/                             # æºä»£ç ç›®å½•
\`\`\`

**ç¬¬äºŒæ­¥ï¼šç”Ÿæˆ project-context.md**
åœ¨ \`docs/project-context.md\` ä¸­è®°å½•é¡¹ç›®çš„æ ¸å¿ƒä¿¡æ¯ï¼š
- é¡¹ç›®æ¦‚è§ˆï¼ˆåç§°ã€ç‰ˆæœ¬ã€ç±»å‹ã€æè¿°ï¼‰
- æŠ€æœ¯æ ˆï¼ˆè¯­è¨€ã€æ¡†æ¶ã€æ„å»ºå·¥å…·ã€æµ‹è¯•æ¡†æ¶ï¼‰
- é¡¹ç›®ç»“æ„ï¼ˆç›®å½•è¯´æ˜ã€å…¥å£æ–‡ä»¶ï¼‰
- æ¶æ„æ¨¡å¼ï¼ˆè®¾è®¡æ¨¡å¼ã€æ¨¡å—åˆ’åˆ†ï¼‰
- ç¼–ç è§„èŒƒï¼ˆä»£ç é£æ ¼ã€å‘½åè§„èŒƒï¼‰
- ä¾èµ–ç®¡ç†ï¼ˆä¸»è¦ä¾èµ–åˆ—è¡¨ï¼‰
- å¼€å‘æµç¨‹ï¼ˆå¸¸ç”¨å‘½ä»¤ï¼‰

**ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆ constitution.md**
åœ¨ \`docs/constitution.md\` ä¸­å®šä¹‰é¡¹ç›®çš„æ ¸å¿ƒåŸåˆ™ï¼š
- ä»£ç é£æ ¼è§„èŒƒ
- æ¶æ„åŸåˆ™
- å®‰å…¨å‡†åˆ™
- æµ‹è¯•è¦æ±‚
- æ–‡æ¡£æ ‡å‡†

**ç¬¬å››æ­¥ï¼šç”Ÿæˆ requirements.mdï¼ˆéœ€æ±‚æ–‡æ¡£ï¼‰**
åœ¨ \`docs/specs/${featureSlug}/requirements.md\` ä¸­è¯¦ç»†æè¿°ï¼š
- åŠŸèƒ½æ¦‚è¿°
- æœ¯è¯­å®šä¹‰
- éœ€æ±‚åˆ—è¡¨ï¼ˆä½¿ç”¨ EARS æ ¼å¼ï¼‰
  - ç”¨æˆ·æ•…äº‹ï¼ˆAs a... I want... So that...ï¼‰
  - éªŒæ”¶æ ‡å‡†ï¼ˆWHEN/WHILE/IF...THEN...SHALLï¼‰
- éåŠŸèƒ½éœ€æ±‚ï¼ˆæ€§èƒ½ã€å®‰å…¨ã€å…¼å®¹æ€§ï¼‰
- ä¾èµ–å…³ç³»

**EARS æ ¼å¼è¯´æ˜**ï¼š
| æ¨¡å¼ | æ ¼å¼ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| Ubiquitous | THE [system] SHALL [response] | å§‹ç»ˆé€‚ç”¨çš„éœ€æ±‚ |
| Event-driven | WHEN [trigger], THE [system] SHALL [response] | äº‹ä»¶è§¦å‘çš„éœ€æ±‚ |
| State-driven | WHILE [condition], THE [system] SHALL [response] | çŠ¶æ€ç›¸å…³çš„éœ€æ±‚ |
| Unwanted | IF [condition], THEN THE [system] SHALL [response] | å¼‚å¸¸å¤„ç†éœ€æ±‚ |

**ç¬¬äº”æ­¥ï¼šç”Ÿæˆ design.mdï¼ˆè®¾è®¡æ–‡æ¡£ï¼‰**
åœ¨ \`docs/specs/${featureSlug}/design.md\` ä¸­æè¿°ï¼š
- æŠ€æœ¯æ–¹æ¡ˆï¼ˆæŠ€æœ¯é€‰å‹åŠç†ç”±ï¼‰
- æ¶æ„è®¾è®¡ï¼ˆç³»ç»Ÿæ¶æ„å›¾ï¼‰
- æ•°æ®æ¨¡å‹ï¼ˆæ•°æ®ç»“æ„å®šä¹‰ï¼‰
- API è®¾è®¡ï¼ˆæ¥å£å®šä¹‰ï¼‰
- æ–‡ä»¶ç»“æ„ï¼ˆæ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
- è®¾è®¡å†³ç­–ï¼ˆé‡è¦å†³ç­–åŠç†ç”±ï¼‰
- é£é™©è¯„ä¼°

**ç¬¬å…­æ­¥ï¼šç”Ÿæˆ research.mdï¼ˆæŠ€æœ¯è°ƒç ”ï¼‰**
åœ¨ \`docs/specs/${featureSlug}/research.md\` ä¸­è®°å½•ï¼š
- æŠ€æœ¯æ ˆè°ƒç ”ç»“æœ
- ç‰ˆæœ¬å…¼å®¹æ€§ç¡®è®¤
- æ½œåœ¨é£é™©è¯†åˆ«
- æœ€ä½³å®è·µè®°å½•
- å‚è€ƒæ–‡æ¡£é“¾æ¥

**ç¬¬ä¸ƒæ­¥ï¼šç”Ÿæˆ tasks.mdï¼ˆä»»åŠ¡åˆ†è§£ï¼‰**
åœ¨ \`docs/specs/${featureSlug}/tasks.md\` ä¸­åˆ†è§£ä»»åŠ¡ï¼š

\`\`\`markdown
# ä»»åŠ¡æ¸…å•ï¼š${projectName}

## æ¦‚è¿°
å®ç° ${projectName} çš„ä»»åŠ¡åˆ†è§£ã€‚

---

## ä»»åŠ¡åˆ—è¡¨

### é˜¶æ®µ 1: é¡¹ç›®åˆå§‹åŒ–
- [ ] 1.1 æ­å»ºé¡¹ç›®éª¨æ¶
  - åˆ›å»ºç›®å½•ç»“æ„
  - åˆå§‹åŒ– package.json
  - _éœ€æ±‚: 1.1_

- [ ] 1.2 é…ç½®å¼€å‘ç¯å¢ƒ
  - é…ç½® TypeScript/ESLint/Prettier
  - _éœ€æ±‚: 1.1_

### é˜¶æ®µ 2: æ ¸å¿ƒåŠŸèƒ½å®ç°
- [ ] 2.1 å®ç°æ•°æ®æ¨¡å‹
  - å®šä¹‰æ•°æ®ç»“æ„
  - _éœ€æ±‚: 2.1_

- [ ] 2.2 å®ç°ä¸šåŠ¡é€»è¾‘
  - æ ¸å¿ƒåŠŸèƒ½å¼€å‘
  - ä¾èµ–: ä»»åŠ¡ 2.1
  - _éœ€æ±‚: 2.2_

### é˜¶æ®µ 3: é›†æˆæµ‹è¯•
- [ ] 3.1 ç¼–å†™æµ‹è¯•ç”¨ä¾‹
  - å•å…ƒæµ‹è¯•
  - é›†æˆæµ‹è¯•
  - _éœ€æ±‚: 3.1_

---

## æ£€æŸ¥ç‚¹
- [ ] é˜¶æ®µ 1 å®Œæˆåï¼šé¡¹ç›®å¯è¿è¡Œ
- [ ] é˜¶æ®µ 2 å®Œæˆåï¼šæ ¸å¿ƒåŠŸèƒ½å¯ç”¨
- [ ] é˜¶æ®µ 3 å®Œæˆåï¼šæµ‹è¯•é€šè¿‡

---

## æ–‡ä»¶å˜æ›´æ¸…å•
| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| src/index.ts | æ–°å»º | å…¥å£æ–‡ä»¶ |
| package.json | æ–°å»º | é¡¹ç›®é…ç½® |

---

**æ ‡è®°è¯´æ˜**ï¼š
- [P]: å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡
- ä¾èµ–: å¿…é¡»åœ¨æŒ‡å®šä»»åŠ¡å®Œæˆåæ‰èƒ½å¼€å§‹
- _éœ€æ±‚: x.x_: å…³è”çš„éœ€æ±‚ç¼–å·
\`\`\`

**ç¬¬å…«æ­¥ï¼šç”Ÿæˆè¾…åŠ©è„šæœ¬**
åˆ›å»ºé¡¹ç›®ç®¡ç†è„šæœ¬ï¼š
- \`scripts/check-prerequisites.sh\`: æ£€æŸ¥ç¯å¢ƒä¾èµ–
- \`scripts/setup.sh\`: è‡ªåŠ¨åŒ–é¡¹ç›®åˆå§‹åŒ–

ğŸ“ **æ³¨æ„äº‹é¡¹**ï¼š
1. æ‰€æœ‰æ–‡æ¡£ç»Ÿä¸€æ”¾åœ¨ \`docs/\` ç›®å½•ä¸‹
2. åŠŸèƒ½è§„æ ¼æ”¾åœ¨ \`docs/specs/{feature-name}/\` ç›®å½•
3. æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ Markdown æ ¼å¼ï¼Œä¿æŒæ¸…æ™°çš„ç»“æ„
4. éµå¾ªé¡¹ç›® constitution ä¸­å®šä¹‰çš„åŸåˆ™
5. ä»»åŠ¡åˆ†è§£è¦è¶³å¤Ÿç»†è‡´ï¼Œæ¯ä¸ªä»»åŠ¡åº”è¯¥åœ¨ 2-4 å°æ—¶å†…å®Œæˆ
6. æ ‡è®°æ¸…æ¥šä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»
7. è¯†åˆ«å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡ä»¥ä¼˜åŒ–å¼€å‘æ•ˆç‡

ğŸš€ **å¼€å§‹æ‰§è¡Œ**ï¼š
ç°åœ¨è¯·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤åˆ›å»ºé¡¹ç›®ç»“æ„å’Œæ‰€æœ‰å¿…éœ€çš„æ–‡æ¡£ã€‚`;

    return {
      content: [
        {
          type: "text",
          text: message,
        },
      ],
    };
  } catch (error) {
    const errorMessage =
      error instanceof Error ? error.message : String(error);
    return {
      content: [
        {
          type: "text",
          text: `âŒ åˆå§‹åŒ–é¡¹ç›®å¤±è´¥: ${errorMessage}`,
        },
      ],
      isError: true,
    };
  }
}

