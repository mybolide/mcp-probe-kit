import { parseArgs, getString, getNumber } from "../utils/parseArgs.js";
import { okStructured } from "../lib/response.js";
import { RalphLoopReportSchema } from "../schemas/structured-output.js";
import type { RalphLoopReport } from "../schemas/structured-output.js";

/**
 * start_ralph æ™ºèƒ½ç¼–æ’å·¥å…·
 * 
 * åœºæ™¯ï¼šRalph Wiggum Loop å¾ªç¯å¼€å‘
 * ç¼–æ’ï¼šç”Ÿæˆ .ralph/ ç›®å½•ç»“æ„ + å®‰å…¨æ¨¡å¼è„šæœ¬ + æ‰§è¡ŒæŒ‡å—
 */

interface RalphArgs {
  goal?: string;
  mode?: string;
  completion_promise?: string;
  test_command?: string;
  cli_command?: string;
  max_iterations?: number;
  max_minutes?: number;
  confirm_every?: number;
  confirm_timeout?: number;
  max_same_output?: number;
  max_diff_lines?: number;
  cooldown_seconds?: number;
}

// é»˜è®¤å€¼ï¼ˆä¿å®ˆå®‰å…¨ï¼‰
const DEFAULTS = {
  mode: "safe",
  completion_promise: "tests passing + requirements met",
  test_command: "npm test",
  cli_command: "claude-code",
  max_iterations: 8,
  max_minutes: 25,
  confirm_every: 1,
  confirm_timeout: 20,
  max_same_output: 2,
  max_diff_lines: 300,
  cooldown_seconds: 8,
};

/**
 * ç”Ÿæˆ PROMPT.md æ¨¡æ¿
 */
function generatePromptTemplate(goal: string, completionPromise: string, testCommand: string): string {
  return `# Ralph Wiggum Loop - Development Prompt

## ğŸ¯ Goal

${goal}

## âœ… Completion Promise

**Exit Condition**: ${completionPromise}

You MUST satisfy BOTH conditions to exit:
1. \`COMPLETION_PROMISE_MET: true\`
2. \`EXIT_SIGNAL: true\`


## ğŸ“‹ Iteration Rules

### 1. Small Steps
- Make ONE focused change per iteration
- Avoid large refactors in a single iteration
- Keep changes under ${DEFAULTS.max_diff_lines} lines when possible

### 2. Test First
- **CRITICAL**: First iteration MUST identify the correct test command for this project
- Check for: package.json scripts, pytest, cargo test, go test, mvn test, etc.
- Update this PROMPT.md with the correct command
- Run tests EVERY iteration: \`${testCommand}\`
- Do NOT proceed if tests fail (unless fixing test failures is the goal)

### 3. Update Progress
- Update \`@fix_plan.md\` after each iteration
  - Mark completed tasks with âœ…
  - Add new discovered tasks
  - Adjust priorities
- Update \`PROGRESS.md\` with:
  - What was done
  - Test results
  - Next step
  - Current status

### 4. State Block (REQUIRED)
At the end of EVERY response, output:

\`\`\`
COMPLETION_PROMISE_MET: [true|false]
EXIT_SIGNAL: [true|false]
SUMMARY: [one-line summary of this iteration]
NEXT_STEP: [what to do next, or "EXIT" if done]
\`\`\`

**Exit Logic**:
- Set \`COMPLETION_PROMISE_MET: true\` only when completion promise is satisfied
- Set \`EXIT_SIGNAL: true\` only when you're confident to exit
- Loop continues if EITHER is false

### 5. Safety Checks
- If stuck or repeating same action â†’ set \`EXIT_SIGNAL: true\` and ask for help
- If single change exceeds ${DEFAULTS.max_diff_lines} lines â†’ stop and break into smaller tasks
- If tests keep failing after 3 attempts â†’ stop and ask for help

---

## ğŸ“‚ Files

- \`@fix_plan.md\`: Task breakdown and priorities
- \`PROGRESS.md\`: Iteration log
- \`STOP\`: Create this file to emergency stop

---

*Generated by MCP Probe Kit - start_ralph*
`;
}

/**
 * ç”Ÿæˆ @fix_plan.md æ¨¡æ¿
 */
function generateFixPlanTemplate(goal: string): string {
  return `# Task Plan: ${goal}

## ğŸ¯ Goal
${goal}

## ğŸ“‹ Tasks

### âœ… Completed
- [ ] Identify correct test command
- [ ] Verify project structure

### ğŸš§ In Progress
- [ ] [Task will be added by agent]

### ğŸ“ Todo
- [ ] [Tasks will be added by agent]

### ğŸ” Discovered Issues
- [Issues will be added during iterations]

---

**Instructions for Agent**:
1. First iteration: identify test command and update PROMPT.md
2. Break down goal into small, testable tasks
3. Mark tasks as completed with âœ…
4. Add new tasks as discovered
5. Keep this file updated every iteration
`;
}


/**
 * ç”Ÿæˆ PROGRESS.md æ¨¡æ¿
 */
function generateProgressTemplate(): string {
  return `# Ralph Loop Progress Log

## Iteration Summary

| Iter | Time | Changed Lines | Tests | Status | Summary |
|------|------|---------------|-------|--------|---------|
| 0    | -    | -             | -     | START  | Loop initialized |

---

## Detailed Log

### Iteration 0 - Initialization
- **Time**: [timestamp]
- **Action**: Loop started
- **Next**: Identify test command and begin first task

---

**Instructions for Agent**:
- Add entry for each iteration
- Include: iteration number, timestamp, what was done, test results, next step
- Keep summary table updated
`;
}

/**
 * ç”Ÿæˆå®‰å…¨æ¨¡å¼è„šæœ¬ (Bash)
 */
function generateSafeScript(params: Required<RalphArgs>): string {
  return `#!/bin/bash
# Ralph Loop - Safe Mode
# Generated by MCP Probe Kit

set -euo pipefail

# ============================================
# SAFETY PARAMETERS (Override with env vars)
# ============================================
MAX_ITERS=\${MAX_ITERS:-${params.max_iterations}}
MAX_MINUTES=\${MAX_MINUTES:-${params.max_minutes}}
CONFIRM_EVERY=\${CONFIRM_EVERY:-${params.confirm_every}}
CONFIRM_TIMEOUT=\${CONFIRM_TIMEOUT:-${params.confirm_timeout}}
MAX_SAME_OUTPUT=\${MAX_SAME_OUTPUT:-${params.max_same_output}}
MAX_DIFF_LINES=\${MAX_DIFF_LINES:-${params.max_diff_lines}}
COOLDOWN_SECONDS=\${COOLDOWN_SECONDS:-${params.cooldown_seconds}}
REQUIRE_TTY=\${REQUIRE_TTY:-1}
CLI_COMMAND=\${CLI_COMMAND:-${params.cli_command}}

# ============================================
# SAFETY CHECKS
# ============================================
if [ "$REQUIRE_TTY" = "1" ] && [ ! -t 0 ]; then
  echo "âŒ ERROR: Not running in interactive terminal (TTY required for safety)"
  echo "   To override: REQUIRE_TTY=0 $0"
  exit 1
fi

if [ ! -f "PROMPT.md" ]; then
  echo "âŒ ERROR: PROMPT.md not found. Run from .ralph/ directory"
  exit 1
fi

# ============================================
# STARTUP WARNING
# ============================================
echo "ğŸš€ Ralph Loop - Safe Mode"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš ï¸  Safety Limits:"
echo "   â€¢ Max iterations: $MAX_ITERS"
echo "   â€¢ Max time: $MAX_MINUTES minutes"
echo "   â€¢ Confirm every: $CONFIRM_EVERY iteration(s)"
echo "   â€¢ Confirm timeout: $CONFIRM_TIMEOUT seconds"
echo "   â€¢ Max same output: $MAX_SAME_OUTPUT times"
echo "   â€¢ Max diff lines: $MAX_DIFF_LINES lines"
echo ""
echo "ğŸ’¡ Emergency stop: touch STOP"
echo "ğŸ’¡ Pause: Ctrl+C"
echo ""
echo "Press Ctrl+C to cancel, or wait 5s to start..."
sleep 5


# ============================================
# INITIALIZATION
# ============================================
ITER=0
START_TIME=$(date +%s)
LAST_OUTPUT_HASH=""
SAME_OUTPUT_COUNT=0
LOG_FILE="ralph.log"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] Loop started" >> "$LOG_FILE"

# ============================================
# MAIN LOOP
# ============================================
while [ $ITER -lt $MAX_ITERS ]; do
  ITER=$((ITER + 1))
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ”„ Iteration $ITER / $MAX_ITERS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  
  # Check: STOP file
  if [ -f "STOP" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SAFE] STOP file detected" >> "$LOG_FILE"
    echo "ğŸ›‘ STOP file detected. Emergency exit."
    exit 0
  fi
  
  # Check: Max time
  CURRENT_TIME=$(date +%s)
  ELAPSED_MINUTES=$(( (CURRENT_TIME - START_TIME) / 60 ))
  if [ $ELAPSED_MINUTES -ge $MAX_MINUTES ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SAFE] Max time reached: $ELAPSED_MINUTES min" >> "$LOG_FILE"
    echo "â° Max time ($MAX_MINUTES min) reached. Stopping."
    exit 0
  fi
  
  # Check: Confirmation required
  if [ $((ITER % CONFIRM_EVERY)) -eq 0 ]; then
    echo ""
    echo "â¸ï¸  Confirmation required (timeout: \${CONFIRM_TIMEOUT}s)"
    echo -n "   Continue? [y/N]: "
    
    if read -t $CONFIRM_TIMEOUT -r REPLY; then
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SAFE] User declined to continue" >> "$LOG_FILE"
        echo "ğŸ›‘ User stopped the loop."
        exit 0
      fi
    else
      echo ""
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SAFE] Confirmation timeout" >> "$LOG_FILE"
      echo "â° Confirmation timeout. Stopping for safety."
      exit 0
    fi
  fi
  
  # Execute Claude Code
  echo "ğŸ¤– Running: $CLI_COMMAND @PROMPT.md"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] Iteration $ITER started" >> "$LOG_FILE"
  
  OUTPUT_FILE="last_output_$ITER.txt"
  if $CLI_COMMAND @PROMPT.md > "$OUTPUT_FILE" 2>&1; then
    cat "$OUTPUT_FILE"
  else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] CLI command failed" >> "$LOG_FILE"
    echo "âŒ CLI command failed. Check $OUTPUT_FILE"
    exit 1
  fi
  
  # Check: Output repetition
  CURRENT_HASH=$(md5sum "$OUTPUT_FILE" 2>/dev/null | cut -d' ' -f1 || echo "")
  if [ "$CURRENT_HASH" = "$LAST_OUTPUT_HASH" ]; then
    SAME_OUTPUT_COUNT=$((SAME_OUTPUT_COUNT + 1))
    if [ $SAME_OUTPUT_COUNT -ge $MAX_SAME_OUTPUT ]; then
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] Output repeated $SAME_OUTPUT_COUNT times" >> "$LOG_FILE"
      echo "âš ï¸  Output repeated $SAME_OUTPUT_COUNT times. Likely stuck. Stopping."
      exit 0
    fi
  else
    SAME_OUTPUT_COUNT=0
  fi
  LAST_OUTPUT_HASH="$CURRENT_HASH"
  
  # Check: Git diff size (if in git repo)
  if git rev-parse --git-dir > /dev/null 2>&1; then
    CHANGED_LINES=$(git diff --stat | tail -1 | grep -oE '[0-9]+ insertion|[0-9]+ deletion' | grep -oE '[0-9]+' | awk '{s+=$1} END {print s}' || echo "0")
    if [ "$CHANGED_LINES" -gt "$MAX_DIFF_LINES" ]; then
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] Changed lines ($CHANGED_LINES) exceeds limit ($MAX_DIFF_LINES)" >> "$LOG_FILE"
      echo "âš ï¸  Changed $CHANGED_LINES lines (limit: $MAX_DIFF_LINES). Please review manually."
      echo "   Run: git diff --stat"
      exit 0
    fi
  fi
  
  # Check: Exit signals in output
  if grep -q "COMPLETION_PROMISE_MET: true" "$OUTPUT_FILE" && grep -q "EXIT_SIGNAL: true" "$OUTPUT_FILE"; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] Both exit conditions met" >> "$LOG_FILE"
    echo "âœ… Completion promise met and exit signal received. Success!"
    exit 0
  fi
  
  # Cooldown
  echo "ğŸ˜´ Cooldown: \${COOLDOWN_SECONDS}s..."
  sleep $COOLDOWN_SECONDS
done

# Max iterations reached
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SAFE] Max iterations reached" >> "$LOG_FILE"
echo "â° Max iterations ($MAX_ITERS) reached. Stopping."
exit 0
`;
}

/**
 * ç”Ÿæˆæ™®é€šæ¨¡å¼è„šæœ¬ (Bash)
 */
function generateNormalScript(params: Required<RalphArgs>): string {
  return `#!/bin/bash
# Ralph Loop - Normal Mode (Use with caution!)
# Generated by MCP Probe Kit

set -euo pipefail

# ============================================
# PARAMETERS
# ============================================
MAX_ITERS=\${MAX_ITERS:-${params.max_iterations}}
CLI_COMMAND=\${CLI_COMMAND:-${params.cli_command}}

echo "ğŸš€ Ralph Loop - Normal Mode"
echo "âš ï¸  WARNING: No confirmation required. Use Ctrl+C to stop."
echo "   Max iterations: $MAX_ITERS"
echo ""
sleep 3

ITER=0
LOG_FILE="ralph.log"

while [ $ITER -lt $MAX_ITERS ]; do
  ITER=$((ITER + 1))
  echo "ğŸ”„ Iteration $ITER / $MAX_ITERS"
  
  if [ -f "STOP" ]; then
    echo "ğŸ›‘ STOP file detected."
    exit 0
  fi
  
  OUTPUT_FILE="last_output_$ITER.txt"
  $CLI_COMMAND @PROMPT.md | tee "$OUTPUT_FILE"
  
  if grep -q "COMPLETION_PROMISE_MET: true" "$OUTPUT_FILE" && grep -q "EXIT_SIGNAL: true" "$OUTPUT_FILE"; then
    echo "âœ… Success!"
    exit 0
  fi
  
  sleep 5
done

echo "â° Max iterations reached."
exit 0
`;
}


/**
 * ç”Ÿæˆ Windows å®‰å…¨æ¨¡å¼è„šæœ¬ (PowerShell)
 */
function generateSafeScriptWindows(params: Required<RalphArgs>): string {
  return `# Ralph Loop - Safe Mode (Windows)
# Generated by MCP Probe Kit

$ErrorActionPreference = "Stop"

# ============================================
# SAFETY PARAMETERS
# ============================================
$MAX_ITERS = if ($env:MAX_ITERS) { [int]$env:MAX_ITERS } else { ${params.max_iterations} }
$MAX_MINUTES = if ($env:MAX_MINUTES) { [int]$env:MAX_MINUTES } else { ${params.max_minutes} }
$CONFIRM_EVERY = if ($env:CONFIRM_EVERY) { [int]$env:CONFIRM_EVERY } else { ${params.confirm_every} }
$CONFIRM_TIMEOUT = if ($env:CONFIRM_TIMEOUT) { [int]$env:CONFIRM_TIMEOUT } else { ${params.confirm_timeout} }
$MAX_SAME_OUTPUT = if ($env:MAX_SAME_OUTPUT) { [int]$env:MAX_SAME_OUTPUT } else { ${params.max_same_output} }
$MAX_DIFF_LINES = if ($env:MAX_DIFF_LINES) { [int]$env:MAX_DIFF_LINES } else { ${params.max_diff_lines} }
$COOLDOWN_SECONDS = if ($env:COOLDOWN_SECONDS) { [int]$env:COOLDOWN_SECONDS } else { ${params.cooldown_seconds} }
$CLI_COMMAND = if ($env:CLI_COMMAND) { $env:CLI_COMMAND } else { "${params.cli_command}" }

if (-not (Test-Path "PROMPT.md")) {
    Write-Host "âŒ ERROR: PROMPT.md not found" -ForegroundColor Red
    exit 1
}

Write-Host "ğŸš€ Ralph Loop - Safe Mode" -ForegroundColor Cyan
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
Write-Host "âš ï¸  Safety Limits:"
Write-Host "   â€¢ Max iterations: $MAX_ITERS"
Write-Host "   â€¢ Max time: $MAX_MINUTES minutes"
Write-Host "   â€¢ Confirm every: $CONFIRM_EVERY iteration(s)"
Write-Host ""
Write-Host "ğŸ’¡ Emergency stop: New-Item -ItemType File -Name STOP"
Write-Host ""
Write-Host "Press Ctrl+C to cancel, or wait 5s to start..."
Start-Sleep -Seconds 5

$ITER = 0
$START_TIME = Get-Date
$LAST_OUTPUT_HASH = ""
$SAME_OUTPUT_COUNT = 0
$LOG_FILE = "ralph.log"

Add-Content -Path $LOG_FILE -Value "[$((Get-Date).ToString('yyyy-MM-dd HH:mm:ss'))] [INFO] Loop started"

while ($ITER -lt $MAX_ITERS) {
    $ITER++
    Write-Host ""
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    Write-Host "ğŸ”„ Iteration $ITER / $MAX_ITERS" -ForegroundColor Yellow
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if (Test-Path "STOP") {
        Add-Content -Path $LOG_FILE -Value "[$((Get-Date).ToString('yyyy-MM-dd HH:mm:ss'))] [SAFE] STOP file detected"
        Write-Host "ğŸ›‘ STOP file detected. Emergency exit." -ForegroundColor Red
        exit 0
    }
    
    $ELAPSED_MINUTES = ((Get-Date) - $START_TIME).TotalMinutes
    if ($ELAPSED_MINUTES -ge $MAX_MINUTES) {
        Add-Content -Path $LOG_FILE -Value "[$((Get-Date).ToString('yyyy-MM-dd HH:mm:ss'))] [SAFE] Max time reached"
        Write-Host "â° Max time reached. Stopping." -ForegroundColor Yellow
        exit 0
    }
    
    if ($ITER % $CONFIRM_EVERY -eq 0) {
        Write-Host ""
        Write-Host "â¸ï¸  Confirmation required" -ForegroundColor Yellow
        $response = Read-Host "   Continue? [y/N]"
        if ($response -notmatch '^[Yy]$') {
            Add-Content -Path $LOG_FILE -Value "[$((Get-Date).ToString('yyyy-MM-dd HH:mm:ss'))] [SAFE] User declined"
            Write-Host "ğŸ›‘ User stopped the loop." -ForegroundColor Red
            exit 0
        }
    }
    
    Write-Host "ğŸ¤– Running: $CLI_COMMAND @PROMPT.md"
    $OUTPUT_FILE = "last_output_$ITER.txt"
    & $CLI_COMMAND "@PROMPT.md" | Tee-Object -FilePath $OUTPUT_FILE
    
    $CURRENT_HASH = (Get-FileHash -Path $OUTPUT_FILE -Algorithm MD5).Hash
    if ($CURRENT_HASH -eq $LAST_OUTPUT_HASH) {
        $SAME_OUTPUT_COUNT++
        if ($SAME_OUTPUT_COUNT -ge $MAX_SAME_OUTPUT) {
            Write-Host "âš ï¸  Output repeated. Likely stuck. Stopping." -ForegroundColor Yellow
            exit 0
        }
    } else {
        $SAME_OUTPUT_COUNT = 0
    }
    $LAST_OUTPUT_HASH = $CURRENT_HASH
    
    $content = Get-Content $OUTPUT_FILE -Raw
    if ($content -match "COMPLETION_PROMISE_MET: true" -and $content -match "EXIT_SIGNAL: true") {
        Write-Host "âœ… Success!" -ForegroundColor Green
        exit 0
    }
    
    Write-Host "ğŸ˜´ Cooldown: \${COOLDOWN_SECONDS}s..."
    Start-Sleep -Seconds $COOLDOWN_SECONDS
}

Write-Host "â° Max iterations reached." -ForegroundColor Yellow
exit 0
`;
}


/**
 * ç”Ÿæˆæ‰§è¡ŒæŒ‡å—
 */
function generateGuide(params: Required<RalphArgs>, isWindows: boolean): string {
  const scriptName = isWindows ? "ralph_loop_safe.ps1" : "ralph_loop_safe.sh";
  const scriptCmd = isWindows ? `powershell -ExecutionPolicy Bypass -File ${scriptName}` : `./${scriptName}`;
  const chmodCmd = isWindows ? "" : `chmod +x ${scriptName}\n`;
  
  return `# ğŸš€ Ralph Loop Setup Complete!

## ğŸ“‚ Generated Files

\`.ralph/\` directory structure:
- \`PROMPT.md\` - Loop prompt with goal and rules
- \`@fix_plan.md\` - Task breakdown (updated by agent)
- \`PROGRESS.md\` - Iteration log (updated by agent)
- \`${scriptName}\` - Safe mode script (default)
- \`ralph_loop.sh\` - Normal mode script (optional, use with caution)

---

## ğŸ¯ Goal

${params.goal}

**Completion Promise**: ${params.completion_promise}

---

## ğŸ›¡ï¸ Safety Configuration (Mode: ${params.mode})

| Parameter | Value | Description |
|-----------|-------|-------------|
| Max Iterations | ${params.max_iterations} | Hard limit on loop count |
| Max Minutes | ${params.max_minutes} | Hard limit on runtime |
| Confirm Every | ${params.confirm_every} | Require confirmation every N iterations |
| Confirm Timeout | ${params.confirm_timeout}s | Auto-stop if no response |
| Max Same Output | ${params.max_same_output} | Stop if output repeats N times |
| Max Diff Lines | ${params.max_diff_lines} | Stop if changes exceed N lines |
| Cooldown | ${params.cooldown_seconds}s | Pause between iterations |

---

## ğŸš€ How to Start

### 1. Create .ralph directory
\`\`\`bash
mkdir -p .ralph
cd .ralph
\`\`\`

### 2. Copy files
Copy the generated content below into respective files:
- \`PROMPT.md\`
- \`@fix_plan.md\`
- \`PROGRESS.md\`
- \`${scriptName}\`

### 3. Make script executable${isWindows ? "" : " (Linux/Mac)"}
\`\`\`bash
${chmodCmd}\`\`\`

### 4. Run the loop
\`\`\`bash
${scriptCmd}
\`\`\`

---

## ğŸ›‘ How to Stop

### Emergency Stop
\`\`\`bash
touch .ralph/STOP
\`\`\`
The loop will exit immediately on next check.

### Manual Stop
Press \`Ctrl+C\` in the terminal.

### Timeout Stop
Don't respond to confirmation prompt (waits ${params.confirm_timeout}s then stops).

---

## âš™ï¸ How to Adjust Parameters

Override via environment variables:

\`\`\`bash
# Example: Increase max iterations to 15
${isWindows ? "$env:MAX_ITERS=15" : "MAX_ITERS=15"} ${scriptCmd}

# Example: Disable confirmation (not recommended!)
${isWindows ? "$env:CONFIRM_EVERY=999" : "CONFIRM_EVERY=999"} ${scriptCmd}

# Example: Use different CLI command
${isWindows ? "$env:CLI_COMMAND='claude'" : "CLI_COMMAND='claude'"} ${scriptCmd}
\`\`\`

Available overrides:
- \`MAX_ITERS\`
- \`MAX_MINUTES\`
- \`CONFIRM_EVERY\`
- \`CONFIRM_TIMEOUT\`
- \`MAX_SAME_OUTPUT\`
- \`MAX_DIFF_LINES\`
- \`COOLDOWN_SECONDS\`
- \`CLI_COMMAND\`

---

## ğŸ“Š How to Monitor

### View logs
\`\`\`bash
tail -f .ralph/ralph.log
\`\`\`

### Check progress
\`\`\`bash
cat .ralph/PROGRESS.md
\`\`\`

### Check tasks
\`\`\`bash
cat .ralph/@fix_plan.md
\`\`\`

### View last output
\`\`\`bash
cat .ralph/last_output_*.txt
\`\`\`

---

## ğŸ’¡ Tips

1. **First iteration is critical**: The agent will identify the correct test command for your project
2. **Watch for repetition**: If output repeats ${params.max_same_output} times, loop auto-stops
3. **Review large changes**: If changes exceed ${params.max_diff_lines} lines, loop stops for manual review
4. **Use git**: Loop works best in git repos (tracks changes, can auto-backup)
5. **Start small**: Default limits are conservative - adjust after successful runs

---

## âš ï¸ Warnings

- **Cost**: Each iteration calls the LLM API. Monitor usage!
- **Normal mode**: Use only when you're confident. No confirmations = potential runaway.
- **Test command**: Wrong test command = wasted iterations. Verify in first run.
- **Background execution**: Not recommended. Always run in foreground with TTY.

---

## ğŸ”— Integration with Other Tools

### Recommended workflow:

1. **Generate context** (optional but recommended):
   \`\`\`bash
   ${params.cli_command} "ä½¿ç”¨ init_project_context ç”Ÿæˆé¡¹ç›®æ–‡æ¡£"
   \`\`\`

2. **Generate feature spec** (if building new feature):
   \`\`\`bash
   ${params.cli_command} "ä½¿ç”¨ start_feature ç”ŸæˆåŠŸèƒ½è§„æ ¼ï¼Œgoal='${params.goal}'"
   \`\`\`

3. **Start Ralph Loop**:
   \`\`\`bash
   cd .ralph
   ${scriptCmd}
   \`\`\`

---

*Generated by MCP Probe Kit - start_ralph v1.0*
`;
}


/**
 * start_ralph ä¸»å‡½æ•°
 */
export async function startRalph(args: any) {
  try {
    const parsedArgs = parseArgs<RalphArgs>(args, {
      defaultValues: DEFAULTS,
      primaryField: "goal",
      fieldAliases: {
        goal: ["ç›®æ ‡", "ä»»åŠ¡", "task"],
        mode: ["æ¨¡å¼"],
        completion_promise: ["å®Œæˆæ¡ä»¶", "é€€å‡ºæ¡ä»¶"],
        test_command: ["æµ‹è¯•å‘½ä»¤"],
        cli_command: ["å‘½ä»¤", "cli"],
        max_iterations: ["æœ€å¤§è¿­ä»£", "max_iters"],
        max_minutes: ["æœ€å¤§æ—¶é—´", "max_time"],
        confirm_every: ["ç¡®è®¤é¢‘ç‡"],
        confirm_timeout: ["ç¡®è®¤è¶…æ—¶"],
        max_same_output: ["æœ€å¤§é‡å¤"],
        max_diff_lines: ["æœ€å¤§å˜æ›´è¡Œæ•°"],
        cooldown_seconds: ["å†·å´æ—¶é—´"],
      },
    });

    const goal = getString(parsedArgs.goal) || "Complete the development task";
    const mode = getString(parsedArgs.mode) || DEFAULTS.mode;
    const completionPromise = getString(parsedArgs.completion_promise) || DEFAULTS.completion_promise;
    const testCommand = getString(parsedArgs.test_command) || DEFAULTS.test_command;
    const cliCommand = getString(parsedArgs.cli_command) || DEFAULTS.cli_command;
    
    const params: Required<RalphArgs> = {
      goal,
      mode,
      completion_promise: completionPromise,
      test_command: testCommand,
      cli_command: cliCommand,
      max_iterations: getNumber(parsedArgs.max_iterations) ?? DEFAULTS.max_iterations,
      max_minutes: getNumber(parsedArgs.max_minutes) ?? DEFAULTS.max_minutes,
      confirm_every: getNumber(parsedArgs.confirm_every) ?? DEFAULTS.confirm_every,
      confirm_timeout: getNumber(parsedArgs.confirm_timeout) ?? DEFAULTS.confirm_timeout,
      max_same_output: getNumber(parsedArgs.max_same_output) ?? DEFAULTS.max_same_output,
      max_diff_lines: getNumber(parsedArgs.max_diff_lines) ?? DEFAULTS.max_diff_lines,
      cooldown_seconds: getNumber(parsedArgs.cooldown_seconds) ?? DEFAULTS.cooldown_seconds,
    };

    // æ£€æµ‹æ“ä½œç³»ç»Ÿ
    const isWindows = process.platform === "win32";

    // ç”Ÿæˆæ‰€æœ‰æ–‡ä»¶å†…å®¹
    const promptMd = generatePromptTemplate(params.goal, params.completion_promise, params.test_command);
    const fixPlanMd = generateFixPlanTemplate(params.goal);
    const progressMd = generateProgressTemplate();
    const safeScript = isWindows 
      ? generateSafeScriptWindows(params)
      : generateSafeScript(params);
    const normalScript = generateNormalScript(params);
    const guide = generateGuide(params, isWindows);

    // ç»„è£…è¾“å‡º
    const scriptExt = isWindows ? "ps1" : "sh";
    const output = `${guide}

---

## ğŸ“„ File Contents

### 1. PROMPT.md
\`\`\`markdown
${promptMd}
\`\`\`

---

### 2. @fix_plan.md
\`\`\`markdown
${fixPlanMd}
\`\`\`

---

### 3. PROGRESS.md
\`\`\`markdown
${progressMd}
\`\`\`

---

### 4. ralph_loop_safe.${scriptExt} (Safe Mode - Recommended)
\`\`\`${isWindows ? 'powershell' : 'bash'}
${safeScript}
\`\`\`

---

### 5. ralph_loop.sh (Normal Mode - Use with Caution)
\`\`\`bash
${normalScript}
\`\`\`

---

## âœ… Next Steps

1. Create \`.ralph/\` directory
2. Copy each file content above into respective files
3. Make scripts executable (if on Linux/Mac)
4. Review PROMPT.md and adjust if needed
5. Run \`ralph_loop_safe.${scriptExt}\`
6. Monitor progress and logs

**Happy coding! ğŸš€**
`;

    // Create structured Ralph Loop report
    const ralphReport: RalphLoopReport = {
      summary: `Ralph Loop å¾ªç¯å¼€å‘ï¼š${params.goal}`,
      status: 'pending',
      steps: [
        {
          name: 'åˆ›å»º .ralph ç›®å½•',
          status: 'pending',
          description: 'åˆ›å»º .ralph/ ç›®å½•ç»“æ„',
        },
        {
          name: 'å¤åˆ¶é…ç½®æ–‡ä»¶',
          status: 'pending',
          description: 'å¤åˆ¶ PROMPT.md, @fix_plan.md, PROGRESS.md å’Œè„šæœ¬æ–‡ä»¶',
        },
        {
          name: 'é…ç½®è„šæœ¬æƒé™',
          status: 'pending',
          description: 'ä½¿è„šæœ¬å¯æ‰§è¡Œï¼ˆLinux/Macï¼‰',
        },
        {
          name: 'å¯åŠ¨å¾ªç¯',
          status: 'pending',
          description: 'è¿è¡Œ ralph_loop_safe è„šæœ¬',
        },
      ],
      artifacts: [
        {
          path: '.ralph/PROMPT.md',
          type: 'doc',
          purpose: 'å¾ªç¯æç¤ºè¯å’Œè§„åˆ™',
        },
        {
          path: '.ralph/@fix_plan.md',
          type: 'doc',
          purpose: 'ä»»åŠ¡åˆ†è§£å’Œä¼˜å…ˆçº§',
        },
        {
          path: '.ralph/PROGRESS.md',
          type: 'doc',
          purpose: 'è¿­ä»£æ—¥å¿—',
        },
        {
          path: `.ralph/ralph_loop_safe.${isWindows ? 'ps1' : 'sh'}`,
          type: 'config',
          purpose: 'å®‰å…¨æ¨¡å¼è„šæœ¬',
        },
      ],
      nextSteps: [
        'åˆ›å»º .ralph/ ç›®å½•',
        'å¤åˆ¶æ–‡ä»¶å†…å®¹åˆ°å¯¹åº”æ–‡ä»¶',
        'ä½¿è„šæœ¬å¯æ‰§è¡Œ',
        'è¿è¡Œ ralph_loop_safe è„šæœ¬',
      ],
      loopPolicy: {
        maxIterations: params.max_iterations,
        maxMinutes: params.max_minutes,
        confirmEvery: params.confirm_every,
        cooldownSeconds: params.cooldown_seconds,
      },
      iterations: [],
      stopConditions: {
        reason: 'æœªå¯åŠ¨',
        metConditions: [],
      },
      safetyChecks: [
        {
          check: 'Max iterations limit',
          passed: true,
          message: `è®¾ç½®ä¸º ${params.max_iterations} æ¬¡`,
        },
        {
          check: 'Max time limit',
          passed: true,
          message: `è®¾ç½®ä¸º ${params.max_minutes} åˆ†é’Ÿ`,
        },
        {
          check: 'Confirmation required',
          passed: true,
          message: `æ¯ ${params.confirm_every} è½®ç¡®è®¤ä¸€æ¬¡`,
        },
      ],
    };

    return okStructured(
      output,
      ralphReport,
      {
        schema: RalphLoopReportSchema,
        note: 'AI åº”è¯¥å¸®åŠ©ç”¨æˆ·åˆ›å»º .ralph/ ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶ï¼Œç„¶åæŒ‡å¯¼ç”¨æˆ·å¯åŠ¨å¾ªç¯',
      }
    );
  } catch (error) {
    const errorMsg = error instanceof Error ? error.message : String(error);
    return {
      content: [{ type: "text", text: `âŒ start_ralph æ‰§è¡Œå¤±è´¥: ${errorMsg}` }],
      isError: true,
    };
  }
}
