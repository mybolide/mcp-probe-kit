/**
 * fix_bug å·¥å…·
 * 
 * åŠŸèƒ½ï¼šæŒ‡å¯¼å®Œæ•´çš„ Bug ä¿®å¤æµç¨‹
 * æ¨¡å¼ï¼šæŒ‡ä»¤ç”Ÿæˆå™¨æ¨¡å¼ - è¿”å›è¯¦ç»†çš„ä¿®å¤æŒ‡å—ï¼Œç”± AI æ‰§è¡Œå®é™…æ“ä½œ
 * 
 * æµç¨‹ï¼šé—®é¢˜å®šä½ â†’ åŸå› åˆ†æ â†’ ä¿®å¤æ–¹æ¡ˆ â†’ éªŒè¯æµ‹è¯•
 */

const PROMPT_TEMPLATE = `# Bug ä¿®å¤æŒ‡å—

## ğŸ› Bug ä¿¡æ¯

**é”™è¯¯ä¿¡æ¯**: 
\`\`\`
{error_message}
\`\`\`

{stack_trace_section}

{reproduce_section}

{behavior_section}

---

## ğŸ“ é˜¶æ®µ 1: é—®é¢˜å®šä½

### æ­¥éª¤ 1.1: åˆ†æé”™è¯¯ä¿¡æ¯

1. **è¯†åˆ«é”™è¯¯ç±»å‹**:
   - è¯­æ³•é”™è¯¯ï¼ˆSyntaxErrorï¼‰
   - è¿è¡Œæ—¶é”™è¯¯ï¼ˆTypeError, ReferenceError, RangeErrorï¼‰
   - é€»è¾‘é”™è¯¯ï¼ˆç»“æœä¸ç¬¦åˆé¢„æœŸï¼‰
   - å¼‚æ­¥é”™è¯¯ï¼ˆPromise rejection, å›è°ƒå¼‚å¸¸ï¼‰

2. **æå–å…³é”®ä¿¡æ¯**:
   - é”™è¯¯åç§°: [ä»é”™è¯¯ä¿¡æ¯ä¸­æå–]
   - é”™è¯¯æ¶ˆæ¯: [å…·ä½“æè¿°]
   - å‘ç”Ÿä½ç½®: [æ–‡ä»¶:è¡Œå·]

### æ­¥éª¤ 1.2: åˆ†æå †æ ˆè·Ÿè¸ª

**æ“ä½œ**:
1. æ‰¾åˆ°å †æ ˆä¸­ç¬¬ä¸€ä¸ªé¡¹ç›®æ–‡ä»¶ï¼ˆæ’é™¤ node_modulesï¼‰
2. è¿½è¸ªè°ƒç”¨é“¾ï¼Œç†è§£æ‰§è¡Œæµç¨‹
3. è®°å½•æ‰€æœ‰ç›¸å…³çš„é¡¹ç›®æ–‡ä»¶

**ç›¸å…³æ–‡ä»¶åˆ—è¡¨**:
| æ–‡ä»¶ | è¡Œå· | å‡½æ•°/æ–¹æ³• |
|------|------|-----------|
| [æ–‡ä»¶è·¯å¾„] | [è¡Œå·] | [å‡½æ•°å] |

### æ­¥éª¤ 1.3: è¯»å–ç›¸å…³ä»£ç 

**æ“ä½œ**: è¯»å–ä»¥ä¸‹æ–‡ä»¶å¹¶åˆ†æï¼š
- é”™è¯¯å‘ç”Ÿçš„æ–‡ä»¶
- è°ƒç”¨é“¾ä¸Šçš„æ–‡ä»¶
- ç›¸å…³çš„é…ç½®æ–‡ä»¶
- ç›¸å…³çš„æµ‹è¯•æ–‡ä»¶ï¼ˆå¦‚æœ‰ï¼‰

### ğŸ“‹ å®šä½ç»“è®º

| é¡¹ç›® | å†…å®¹ |
|------|------|
| é—®é¢˜æ–‡ä»¶ | [æ–‡ä»¶è·¯å¾„] |
| é—®é¢˜ä½ç½® | ç¬¬ X è¡Œ |
| é—®é¢˜ä»£ç  | \`[ä»£ç ç‰‡æ®µ]\` |
| è§¦å‘æ¡ä»¶ | [ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘] |

---

## ğŸ” é˜¶æ®µ 2: åŸå› åˆ†æ

### æ­¥éª¤ 2.1: 5 Whys åˆ†æ

ä½¿ç”¨ 5 Whys æ–¹æ³•æ·±å…¥åˆ†ææ ¹æœ¬åŸå› ï¼š

1. **Why 1**: ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Ÿ
   - [ç­”æ¡ˆ]

2. **Why 2**: ä¸ºä»€ä¹ˆä¼š [Why 1 çš„ç­”æ¡ˆ]ï¼Ÿ
   - [ç­”æ¡ˆ]

3. **Why 3**: ä¸ºä»€ä¹ˆä¼š [Why 2 çš„ç­”æ¡ˆ]ï¼Ÿ
   - [ç­”æ¡ˆ]

4. **Why 4**: ä¸ºä»€ä¹ˆä¼š [Why 3 çš„ç­”æ¡ˆ]ï¼Ÿ
   - [ç­”æ¡ˆ]

5. **Why 5**: ä¸ºä»€ä¹ˆä¼š [Why 4 çš„ç­”æ¡ˆ]ï¼Ÿ
   - [ç­”æ¡ˆ]

### æ­¥éª¤ 2.2: ä»£ç é€»è¾‘åˆ†æ

1. **æ•°æ®æµåˆ†æ**: è¿½è¸ªæ•°æ®ä»è¾“å…¥åˆ°å‡ºé”™ä½ç½®çš„æµåŠ¨
2. **çŠ¶æ€åˆ†æ**: æ£€æŸ¥ç›¸å…³å˜é‡/çŠ¶æ€åœ¨å‡ºé”™æ—¶çš„å€¼
3. **è¾¹ç•Œæ¡ä»¶**: æ£€æŸ¥æ˜¯å¦å¤„ç†äº†æ‰€æœ‰è¾¹ç•Œæƒ…å†µ
4. **å¼‚å¸¸å¤„ç†**: æ£€æŸ¥æ˜¯å¦æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†

### ğŸ“‹ åˆ†æç»“è®º

| é¡¹ç›® | å†…å®¹ |
|------|------|
| ç›´æ¥åŸå›  | [ç›´æ¥å¯¼è‡´é”™è¯¯çš„åŸå› ] |
| æ ¹æœ¬åŸå›  | [æ·±å±‚æ¬¡çš„åŸå› ] |
| è§¦å‘æ¡ä»¶ | [ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘] |
| å½±å“èŒƒå›´ | [å—å½±å“çš„åŠŸèƒ½/æ¨¡å—] |

---

## ğŸ”§ é˜¶æ®µ 3: ä¿®å¤æ–¹æ¡ˆ

### æ­¥éª¤ 3.1: è®¾è®¡ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ A**: [æ–¹æ¡ˆæè¿°]
- ä¿®æ”¹å†…å®¹: [å…·ä½“ä¿®æ”¹]
- ä¼˜ç‚¹: [ä¼˜ç‚¹]
- ç¼ºç‚¹: [ç¼ºç‚¹]
- é£é™©: [æ½œåœ¨é£é™©]

**æ–¹æ¡ˆ B**: [å¤‡é€‰æ–¹æ¡ˆæè¿°]
- ä¿®æ”¹å†…å®¹: [å…·ä½“ä¿®æ”¹]
- ä¼˜ç‚¹: [ä¼˜ç‚¹]
- ç¼ºç‚¹: [ç¼ºç‚¹]
- é£é™©: [æ½œåœ¨é£é™©]

**é€‰æ‹©æ–¹æ¡ˆ**: [é€‰æ‹©çš„æ–¹æ¡ˆ]
**é€‰æ‹©ç†ç”±**: [ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹æ¡ˆ]

### æ­¥éª¤ 3.2: å½±å“èŒƒå›´è¯„ä¼°

| å½±å“é¡¹ | è¯´æ˜ |
|--------|------|
| ä¿®æ”¹æ–‡ä»¶ | [æ–‡ä»¶åˆ—è¡¨] |
| å½±å“åŠŸèƒ½ | [åŠŸèƒ½åˆ—è¡¨] |
| éœ€è¦æµ‹è¯• | [æµ‹è¯•èŒƒå›´] |
| æ˜¯å¦éœ€è¦å›å½’ | [æ˜¯/å¦] |

### æ­¥éª¤ 3.3: å®æ–½ä¿®å¤

**ä¿®æ”¹æ–‡ä»¶**: \`[æ–‡ä»¶è·¯å¾„]\`

**ä¿®æ”¹å‰**:
\`\`\`
[åŸä»£ç ]
\`\`\`

**ä¿®æ”¹å**:
\`\`\`
[æ–°ä»£ç ]
\`\`\`

**ä¿®æ”¹è¯´æ˜**: [è§£é‡Šä¿®æ”¹çš„åŸå› å’Œé€»è¾‘]

---

## âœ… é˜¶æ®µ 4: éªŒè¯æµ‹è¯•

### æ­¥éª¤ 4.1: å•å…ƒæµ‹è¯•

ä¸ºä¿®å¤ç¼–å†™é’ˆå¯¹æ€§çš„å•å…ƒæµ‹è¯•ï¼š

\`\`\`typescript
describe('[åŠŸèƒ½æè¿°]', () => {
  // æµ‹è¯•æ­£å¸¸æƒ…å†µ
  it('should [æ­£å¸¸è¡Œä¸ºæè¿°]', () => {
    // æµ‹è¯•ä»£ç 
  });
  
  // æµ‹è¯•ä¿®å¤çš„ Bug åœºæ™¯
  it('should handle [Bug åœºæ™¯]', () => {
    // æµ‹è¯•ä»£ç  - ç¡®ä¿ Bug å·²ä¿®å¤
  });
  
  // æµ‹è¯•è¾¹ç•Œæƒ…å†µ
  it('should handle [è¾¹ç•Œæƒ…å†µ]', () => {
    // è¾¹ç•Œæµ‹è¯•
  });
});
\`\`\`

### æ­¥éª¤ 4.2: æ‰‹åŠ¨éªŒè¯

1. [ ] æŒ‰åŸå¤ç°æ­¥éª¤éªŒè¯é—®é¢˜å·²ä¿®å¤
2. [ ] éªŒè¯æ­£å¸¸æµç¨‹ä¸å—å½±å“
3. [ ] éªŒè¯è¾¹ç•Œæƒ…å†µå¤„ç†æ­£ç¡®
4. [ ] éªŒè¯é”™è¯¯å¤„ç†æ­£ç¡®

### æ­¥éª¤ 4.3: å›å½’æµ‹è¯•

1. [ ] è¿è¡Œç›¸å…³æ¨¡å—çš„æµ‹è¯•
2. [ ] è¿è¡Œå…¨é‡æµ‹è¯•ï¼ˆå¦‚æœ‰ CIï¼‰
3. [ ] æ£€æŸ¥æ˜¯å¦å¼•å…¥æ–°é—®é¢˜

---

## ğŸ“‹ ä¿®å¤æ£€æŸ¥æ¸…å•

### å®šä½é˜¶æ®µ
- [ ] é”™è¯¯ç±»å‹å·²è¯†åˆ«
- [ ] é—®é¢˜ä»£ç å·²å®šä½
- [ ] ç›¸å…³æ–‡ä»¶å·²è¯»å–

### åˆ†æé˜¶æ®µ
- [ ] 5 Whys åˆ†æå·²å®Œæˆ
- [ ] æ ¹æœ¬åŸå› å·²ç¡®å®š
- [ ] å½±å“èŒƒå›´å·²è¯„ä¼°

### ä¿®å¤é˜¶æ®µ
- [ ] ä¿®å¤æ–¹æ¡ˆå·²è®¾è®¡
- [ ] ä»£ç ä¿®æ”¹å·²å®Œæˆ
- [ ] ä¿®æ”¹å·²è§£é‡Šæ¸…æ¥š

### éªŒè¯é˜¶æ®µ
- [ ] å•å…ƒæµ‹è¯•å·²æ·»åŠ 
- [ ] æ‰‹åŠ¨éªŒè¯å·²é€šè¿‡
- [ ] å›å½’æµ‹è¯•å·²é€šè¿‡

### æäº¤é˜¶æ®µ
- [ ] ä»£ç å·²æäº¤
- [ ] Commit message æ¸…æ™°æè¿°äº†ä¿®å¤å†…å®¹

---

## ğŸ“ ä¿®å¤æ€»ç»“

å®Œæˆä¿®å¤åï¼Œå¡«å†™ä»¥ä¸‹æ€»ç»“ï¼š

| é¡¹ç›® | å†…å®¹ |
|------|------|
| Bug æè¿° | [ç®€è¿°] |
| æ ¹æœ¬åŸå›  | [åŸå› ] |
| ä¿®å¤æ–¹æ¡ˆ | [æ–¹æ¡ˆ] |
| ä¿®æ”¹æ–‡ä»¶ | [æ–‡ä»¶åˆ—è¡¨] |
| æµ‹è¯•è¦†ç›– | [æµ‹è¯•æƒ…å†µ] |
| ä¿®å¤æ—¶é—´ | [è€—æ—¶] |

---

## ğŸ’¡ ç»éªŒæ•™è®­

è®°å½•æœ¬æ¬¡ Bug çš„ç»éªŒæ•™è®­ï¼Œé¿å…ç±»ä¼¼é—®é¢˜ï¼š

1. **ä»£ç å±‚é¢**: [å¦‚ä½•é¿å…å†™å‡ºç±»ä¼¼ Bug]
2. **æµ‹è¯•å±‚é¢**: [åº”è¯¥å¢åŠ ä»€ä¹ˆæµ‹è¯•]
3. **æµç¨‹å±‚é¢**: [æµç¨‹ä¸Šå¦‚ä½•æ”¹è¿›]

---

## ğŸ“¤ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºä¿®å¤æŒ‡å—ï¼š

\`\`\`json
{
  "bug_summary": "Bug ç®€è¿°ï¼ˆä¸€å¥è¯ï¼‰",
  "analysis": {
    "error_type": "é”™è¯¯ç±»å‹",
    "direct_cause": "ç›´æ¥åŸå› ",
    "root_cause": "æ ¹æœ¬åŸå› ",
    "affected_scope": "å½±å“èŒƒå›´"
  },
  "location": {
    "file": "é—®é¢˜æ–‡ä»¶è·¯å¾„",
    "line": 42,
    "function": "é—®é¢˜å‡½æ•°å",
    "code_snippet": "é—®é¢˜ä»£ç ç‰‡æ®µ"
  },
  "fix_plan": {
    "chosen_solution": "é€‰æ‹©çš„ä¿®å¤æ–¹æ¡ˆ",
    "reason": "é€‰æ‹©ç†ç”±",
    "steps": [
      { "step": 1, "action": "ä¿®å¤æ­¥éª¤", "file": "æ–‡ä»¶", "change": "å˜æ›´å†…å®¹" }
    ],
    "code_before": "ä¿®æ”¹å‰ä»£ç ",
    "code_after": "ä¿®æ”¹åä»£ç "
  },
  "verification": {
    "test_cases": ["æµ‹è¯•ç”¨ä¾‹1", "æµ‹è¯•ç”¨ä¾‹2"],
    "manual_checks": ["æ‰‹åŠ¨éªŒè¯é¡¹1", "æ‰‹åŠ¨éªŒè¯é¡¹2"]
  }
}
\`\`\`

## âš ï¸ è¾¹ç•Œçº¦æŸ

- âŒ ä»…æä¾›ä¿®å¤æŒ‡å—ï¼Œä¸ä¿è¯è‡ªåŠ¨ä¿®æ”¹ä»£ç 
- âŒ ä¸æ‰§è¡Œä»£ç æˆ–å‘½ä»¤
- âœ… è¾“å‡ºç»“æ„åŒ–ä¿®å¤æ–¹æ¡ˆå’ŒéªŒè¯æ­¥éª¤
- ğŸ’¡ å¦‚éœ€è‡ªåŠ¨ä¿®å¤ï¼Œå¯é…åˆ fix å·¥å…·åº”ç”¨ patch

---

*æŒ‡å—ç‰ˆæœ¬: 1.0.0*
*å·¥å…·: MCP Probe Kit - fix_bug*
`;

/**
 * fix_bug å·¥å…·å®ç°
 */
export async function fixBug(args: any) {
  try {
    const errorMessage = args?.error_message;

    if (!errorMessage) {
      throw new Error("ç¼ºå°‘å¿…å¡«å‚æ•°: error_messageï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰");
    }

    const stackTrace = args?.stack_trace || "";
    const stepsToReproduce = args?.steps_to_reproduce || "";
    const expectedBehavior = args?.expected_behavior || "";
    const actualBehavior = args?.actual_behavior || "";

    // æ„å»ºå¯é€‰éƒ¨åˆ†
    const stackTraceSection = stackTrace
      ? `**å †æ ˆè·Ÿè¸ª**:\n\`\`\`\n${stackTrace}\n\`\`\``
      : "**å †æ ˆè·Ÿè¸ª**: æœªæä¾›ï¼ˆå»ºè®®æä¾›ä»¥ä¾¿æ›´å‡†ç¡®å®šä½ï¼‰";

    const reproduceSection = stepsToReproduce
      ? `**å¤ç°æ­¥éª¤**:\n${stepsToReproduce}`
      : "";

    let behaviorSection = "";
    if (expectedBehavior || actualBehavior) {
      behaviorSection = [
        expectedBehavior ? `**æœŸæœ›è¡Œä¸º**: ${expectedBehavior}` : "",
        actualBehavior ? `**å®é™…è¡Œä¸º**: ${actualBehavior}` : "",
      ]
        .filter(Boolean)
        .join("\n\n");
    }

    const guide = PROMPT_TEMPLATE
      .replace(/{error_message}/g, errorMessage)
      .replace(/{stack_trace_section}/g, stackTraceSection)
      .replace(/{reproduce_section}/g, reproduceSection)
      .replace(/{behavior_section}/g, behaviorSection);

    return {
      content: [{ type: "text", text: guide }],
    };
  } catch (error) {
    const errorMsg = error instanceof Error ? error.message : String(error);
    return {
      content: [{ type: "text", text: `âŒ ç”Ÿæˆä¿®å¤æŒ‡å—å¤±è´¥: ${errorMsg}` }],
      isError: true,
    };
  }
}
