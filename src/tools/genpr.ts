import { parseArgs, getString } from "../utils/parseArgs.js";

// genpr å·¥å…·å®ç°
export async function genpr(args: any) {
  try {
    // æ™ºèƒ½å‚æ•°è§£æï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€è¾“å…¥
    const parsedArgs = parseArgs<{
      branch?: string;
      commits?: string;
    }>(args, {
      defaultValues: {
        branch: "",
        commits: "",
      },
      primaryField: "commits", // çº¯æ–‡æœ¬è¾“å…¥é»˜è®¤æ˜ å°„åˆ° commits å­—æ®µ
      fieldAliases: {
        branch: ["åˆ†æ”¯", "branch_name"],
        commits: ["commit_history", "log", "æäº¤", "æäº¤å†å²"],
      },
    });
    
    const branch = getString(parsedArgs.branch);
    const commits = getString(parsedArgs.commits);

    const message = `è¯·ç”Ÿæˆè§„èŒƒçš„ Pull Request æè¿°ï¼š

ğŸ“ **åˆ†æ”¯ä¿¡æ¯**ï¼š
${branch || "è¯·æä¾›åˆ†æ”¯åç§°"}

ğŸ“‹ **Commit å†å²**ï¼š
${commits || "è¯·å…ˆæ‰§è¡Œ git log æŸ¥çœ‹ commit å†å²"}

---

## PR æè¿°ç”ŸæˆæŒ‡å—

### ç¬¬ä¸€æ­¥ï¼šåˆ†æå˜æ›´å†…å®¹

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è·å–è¯¦ç»†ä¿¡æ¯ï¼š
\`\`\`bash
# æŸ¥çœ‹ commit å†å²
git log origin/main..HEAD --oneline

# æŸ¥çœ‹å…·ä½“å˜æ›´
git diff origin/main..HEAD --stat

# æŸ¥çœ‹ä¿®æ”¹çš„æ–‡ä»¶
git diff origin/main..HEAD --name-only
\`\`\`

### ç¬¬äºŒæ­¥ï¼šç”Ÿæˆ PR æè¿°

**æ ‡å‡† PR æ¨¡æ¿**ï¼š

\`\`\`markdown
## ğŸ“ å˜æ›´è¯´æ˜

### æ¦‚è¿°
ç®€è¦è¯´æ˜è¿™ä¸ª PR çš„ç›®çš„å’ŒèƒŒæ™¯ï¼ˆ2-3 å¥è¯ï¼‰

### å˜æ›´å†…å®¹
- ğŸ¨ UI/UX æ”¹è¿›ï¼š...
- âœ¨ æ–°åŠŸèƒ½ï¼š...
- ğŸ› Bug ä¿®å¤ï¼š...
- â™»ï¸ é‡æ„ï¼š...
- ğŸ“ æ–‡æ¡£æ›´æ–°ï¼š...
- ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼š...

## ğŸ¯ è§£å†³çš„é—®é¢˜

Closes #123
Fixes #456
Relates to #789

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¸»è¦ä¿®æ”¹
1. **æ¨¡å— A**ï¼šä¿®æ”¹å†…å®¹å’ŒåŸå› 
2. **æ¨¡å— B**ï¼šä¿®æ”¹å†…å®¹å’ŒåŸå› 

### æ¶æ„å˜æ›´ï¼ˆå¦‚æœ‰ï¼‰
- æ•°æ®åº“ Schema å˜æ›´
- API æ¥å£å˜æ›´
- é…ç½®æ–‡ä»¶å˜æ›´

### ä¾èµ–å˜æ›´ï¼ˆå¦‚æœ‰ï¼‰
- æ–°å¢ä¾èµ–ï¼š\`package-name@version\`
- ç§»é™¤ä¾èµ–ï¼š\`old-package\`
- å‡çº§ä¾èµ–ï¼š\`package@old â†’ package@new\`

## âœ… æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [x] æ–°å¢æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ–°åŠŸèƒ½
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [x] æµ‹è¯•è¦†ç›–ç‡ > 80%

### é›†æˆæµ‹è¯•
- [x] API æ¥å£æµ‹è¯•é€šè¿‡
- [x] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡

### æ‰‹åŠ¨æµ‹è¯•
- [x] åŠŸèƒ½ A æ­£å¸¸å·¥ä½œ
- [x] åŠŸèƒ½ B æ­£å¸¸å·¥ä½œ
- [x] è¾¹ç•Œæƒ…å†µéªŒè¯

## ğŸ“¸ æˆªå›¾/å½•å±ï¼ˆUI å˜æ›´æ—¶ï¼‰

### Before
![Before Screenshot](url)

### After
![After Screenshot](url)

## âš ï¸ æ³¨æ„äº‹é¡¹

### Breaking Changesï¼ˆç ´åæ€§å˜æ›´ï¼‰
- âš ï¸ API è·¯å¾„ä» \`/old\` æ”¹ä¸º \`/new\`
- âš ï¸ é…ç½®æ–‡ä»¶æ ¼å¼å˜æ›´

### éƒ¨ç½²æ³¨æ„
- éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼š\`npm run migrate\`
- éœ€è¦æ›´æ–°ç¯å¢ƒå˜é‡ï¼š\`NEW_VAR=value\`
- éœ€è¦é‡å¯æœåŠ¡

### å‘åå…¼å®¹æ€§
- âœ… å®Œå…¨å…¼å®¹
- âš ï¸ éƒ¨åˆ†å…¼å®¹ï¼ˆè¯´æ˜ä¸å…¼å®¹çš„éƒ¨åˆ†ï¼‰
- âŒ ä¸å…¼å®¹ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰

## ğŸ“‹ Checklist

- [ ] ä»£ç é€šè¿‡ lint æ£€æŸ¥
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] Changelog å·²æ›´æ–°
- [ ] æ€§èƒ½å½±å“å·²è¯„ä¼°
- [ ] å®‰å…¨å½±å“å·²è¯„ä¼°
- [ ] ä»£ç å·²è‡ªæˆ‘å®¡æŸ¥
- [ ] å·²æ·»åŠ å¿…è¦çš„æ³¨é‡Š

## ğŸ”— ç›¸å…³é“¾æ¥

- è®¾è®¡æ–‡æ¡£ï¼š[é“¾æ¥]
- æŠ€æœ¯æ–¹æ¡ˆï¼š[é“¾æ¥]
- ç›¸å…³ PRï¼š#xxx

## ğŸ‘¥ å®¡æŸ¥è€…

@reviewer1 @reviewer2

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ @contributor1 çš„å»ºè®®
\`\`\`

---

## PR æ ‡é¢˜è§„èŒƒ

æ ¼å¼ï¼š\`<type>(<scope>): <subject>\`

**ç¤ºä¾‹**ï¼š
- \`feat(auth): æ·»åŠ  OAuth2 ç™»å½•æ”¯æŒ\`
- \`fix(api): ä¿®å¤ç”¨æˆ·æŸ¥è¯¢æ¥å£åˆ†é¡µé”™è¯¯\`
- \`refactor(ui): é‡æ„ç»„ä»¶å±‚çº§ç»“æ„\`

---

---

## âš ï¸ è¾¹ç•Œçº¦æŸ

- âŒ ä»…è¾“å‡º PR æè¿°æ–‡æœ¬ï¼Œä¸è‡ªåŠ¨åˆ›å»º PR
- âŒ ä¸æ‰§è¡Œ git å‘½ä»¤
- âœ… è¾“å‡ºå®Œæ•´çš„ PR æè¿° Markdown

ç°åœ¨è¯·æ ¹æ®å˜æ›´å†…å®¹ç”Ÿæˆå®Œæ•´çš„ PR æè¿°ï¼Œå¹¶å»ºè®®åˆé€‚çš„å®¡æŸ¥è€…ã€‚`;

    return {
      content: [
        {
          type: "text",
          text: message,
        },
      ],
    };
  } catch (error) {
    const errorMessage =
      error instanceof Error ? error.message : String(error);
    return {
      content: [
        {
          type: "text",
          text: `âŒ ç”Ÿæˆ PR æè¿°å¤±è´¥: ${errorMessage}`,
        },
      ],
      isError: true,
    };
  }
}

