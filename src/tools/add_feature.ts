import { parseArgs, getString, validateRequired } from "../utils/parseArgs.js";
import { okStructured } from "../lib/response.js";
import type { FeatureSpec } from "../schemas/output/project-tools.js";

/**
 * add_feature å·¥å…·
 * 
 * åŠŸèƒ½ï¼šä¸ºå·²æœ‰é¡¹ç›®æ·»åŠ æ–°åŠŸèƒ½çš„è§„æ ¼æ–‡æ¡£
 * æ¨¡å¼ï¼šæŒ‡ä»¤ç”Ÿæˆå™¨æ¨¡å¼ - è¿”å›è¯¦ç»†çš„ç”ŸæˆæŒ‡å—ï¼Œç”± AI æ‰§è¡Œå®é™…æ“ä½œ
 * 
 * è¾“å‡ºæ–‡ä»¶ï¼š
 * - docs/specs/{feature_name}/requirements.md - éœ€æ±‚æ–‡æ¡£
 * - docs/specs/{feature_name}/design.md - è®¾è®¡æ–‡æ¡£
 * - docs/specs/{feature_name}/tasks.md - ä»»åŠ¡æ¸…å•
 */

// é»˜è®¤æ–‡æ¡£ç›®å½•
const DEFAULT_DOCS_DIR = "docs";

/**
 * ä»è‡ªç„¶è¯­è¨€è¾“å…¥ä¸­æå–åŠŸèƒ½åå’Œæè¿°
 * @param input - è‡ªç„¶è¯­è¨€è¾“å…¥
 * @returns æå–çš„åŠŸèƒ½åå’Œæè¿°
 */
function extractFeatureInfo(input: string): { name: string; description: string } {
  // ç§»é™¤å¸¸è§çš„å¼•å¯¼è¯
  let text = input
    .replace(/^(æ·»åŠ |å®ç°|å¼€å‘|åˆ›å»º|æ–°å¢|ç”Ÿæˆ|æ„å»º|åš|è¦|æƒ³è¦|éœ€è¦|å¸®æˆ‘|è¯·|éº»çƒ¦)/i, "")
    .trim();
  
  // ç§»é™¤ç»“å°¾çš„"åŠŸèƒ½"ã€"æ¨¡å—"ç­‰è¯
  text = text.replace(/(åŠŸèƒ½|æ¨¡å—|ç‰¹æ€§|ç»„ä»¶|ç³»ç»Ÿ|æœåŠ¡)$/i, "").trim();
  
  // å¦‚æœæ–‡æœ¬å¾ˆçŸ­ï¼ˆå°‘äº20ä¸ªå­—ç¬¦ï¼‰ï¼Œç›´æ¥ä½œä¸ºåŠŸèƒ½å
  if (text.length < 20) {
    const name = text
      .toLowerCase()
      .replace(/[\s\u4e00-\u9fa5]+/g, "-") // å°†ç©ºæ ¼å’Œä¸­æ–‡æ›¿æ¢ä¸ºè¿å­—ç¬¦
      .replace(/[^a-z0-9-]/g, "") // ç§»é™¤éå­—æ¯æ•°å­—å’Œè¿å­—ç¬¦
      .replace(/-+/g, "-") // åˆå¹¶å¤šä¸ªè¿å­—ç¬¦
      .replace(/^-|-$/g, ""); // ç§»é™¤é¦–å°¾è¿å­—ç¬¦
    
    return {
      name: name || "new-feature",
      description: input,
    };
  }
  
  // å¦‚æœæ–‡æœ¬è¾ƒé•¿ï¼Œå°è¯•æå–å…³é”®è¯ä½œä¸ºåŠŸèƒ½å
  // æå–å‰å‡ ä¸ªå…³é”®è¯
  const words = text.split(/[\s,ï¼Œã€]+/).filter(w => w.length > 0);
  const keyWords = words.slice(0, 3).join(" ");
  
  const name = keyWords
    .toLowerCase()
    .replace(/[\s\u4e00-\u9fa5]+/g, "-")
    .replace(/[^a-z0-9-]/g, "")
    .replace(/-+/g, "-")
    .replace(/^-|-$/g, "");
  
  return {
    name: name || "new-feature",
    description: input,
  };
}

// æç¤ºè¯æ¨¡æ¿
const PROMPT_TEMPLATE = `# æ·»åŠ æ–°åŠŸèƒ½æŒ‡å—

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

ä¸ºé¡¹ç›®æ·»åŠ æ–°åŠŸèƒ½ï¼š**{feature_name}**

**åŠŸèƒ½æè¿°**: {description}

---

## ğŸ“‹ å‰ç½®æ£€æŸ¥

### æ£€æŸ¥é¡¹ç›®ä¸Šä¸‹æ–‡

1. æ£€æŸ¥æ–‡ä»¶ \`{docs_dir}/project-context.md\` æ˜¯å¦å­˜åœ¨
2. å¦‚æœå­˜åœ¨ï¼Œè¯»å–å¹¶å‚è€ƒå…¶ä¸­çš„æŠ€æœ¯æ ˆã€æ¶æ„æ¨¡å¼ã€ç¼–ç è§„èŒƒ
3. å¦‚æœä¸å­˜åœ¨ï¼Œå»ºè®®å…ˆè¿è¡Œ \`init_project_context\` å·¥å…·

---

## ğŸ“ åˆ›å»ºæ–‡æ¡£

è¯·åœ¨ \`{docs_dir}/specs/{feature_name}/\` ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š

### æ–‡ä»¶ 1: requirements.md

**æ–‡ä»¶è·¯å¾„**: \`{docs_dir}/specs/{feature_name}/requirements.md\`

**æ–‡ä»¶å†…å®¹**ï¼ˆè¯·å°†ä»¥ä¸‹æ¨¡æ¿ä¿å­˜ä¸ºè¯¥æ–‡ä»¶ï¼Œå¹¶æ ¹æ®åŠŸèƒ½æè¿°æ™ºèƒ½å¡«å……æ ‡è®°ä¸º [å¡«å†™] çš„éƒ¨åˆ†ï¼‰:

\`\`\`markdown
# éœ€æ±‚æ–‡æ¡£ï¼š{feature_name}

## åŠŸèƒ½æ¦‚è¿°

{description}

## æœ¯è¯­å®šä¹‰

- **[æœ¯è¯­1]**: [å¡«å†™ï¼šå®šä¹‰]
- **[æœ¯è¯­2]**: [å¡«å†™ï¼šå®šä¹‰]

---

## éœ€æ±‚åˆ—è¡¨

### éœ€æ±‚ 1: [å¡«å†™ï¼šéœ€æ±‚æ ‡é¢˜]

**ç”¨æˆ·æ•…äº‹:** ä½œä¸º [å¡«å†™ï¼šè§’è‰²]ï¼Œæˆ‘æƒ³è¦ [å¡«å†™ï¼šåŠŸèƒ½]ï¼Œä»¥ä¾¿ [å¡«å†™ï¼šç›®æ ‡]ã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN [å¡«å†™ï¼šè§¦å‘æ¡ä»¶] THEN ç³»ç»Ÿ SHALL [å¡«å†™ï¼šå“åº”]
2. WHILE [å¡«å†™ï¼šçŠ¶æ€æ¡ä»¶] THE ç³»ç»Ÿ SHALL [å¡«å†™ï¼šå“åº”]
3. IF [å¡«å†™ï¼šå¼‚å¸¸æ¡ä»¶] THEN ç³»ç»Ÿ SHALL [å¡«å†™ï¼šå¤„ç†æ–¹å¼]

---

### éœ€æ±‚ 2: [å¡«å†™ï¼šéœ€æ±‚æ ‡é¢˜]

**ç”¨æˆ·æ•…äº‹:** ä½œä¸º [å¡«å†™ï¼šè§’è‰²]ï¼Œæˆ‘æƒ³è¦ [å¡«å†™ï¼šåŠŸèƒ½]ï¼Œä»¥ä¾¿ [å¡«å†™ï¼šç›®æ ‡]ã€‚

#### éªŒæ”¶æ ‡å‡†

1. THE ç³»ç»Ÿ SHALL [å¡«å†™ï¼šå“åº”]
2. WHEN [å¡«å†™ï¼šè§¦å‘æ¡ä»¶] THE ç³»ç»Ÿ SHALL [å¡«å†™ï¼šå“åº”]

---

## EARS æ ¼å¼è¯´æ˜

æœ¬æ–‡æ¡£ä½¿ç”¨ EARS (Easy Approach to Requirements Syntax) æ ¼å¼ç¼–å†™éœ€æ±‚ï¼š

| æ¨¡å¼ | æ ¼å¼ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| Ubiquitous | THE [system] SHALL [response] | å§‹ç»ˆé€‚ç”¨çš„éœ€æ±‚ |
| Event-driven | WHEN [trigger], THE [system] SHALL [response] | äº‹ä»¶è§¦å‘çš„éœ€æ±‚ |
| State-driven | WHILE [condition], THE [system] SHALL [response] | çŠ¶æ€ç›¸å…³çš„éœ€æ±‚ |
| Unwanted | IF [condition], THEN THE [system] SHALL [response] | å¼‚å¸¸å¤„ç†éœ€æ±‚ |
| Optional | WHERE [option], THE [system] SHALL [response] | å¯é€‰åŠŸèƒ½éœ€æ±‚ |

---

## éåŠŸèƒ½éœ€æ±‚

### æ€§èƒ½è¦æ±‚
- [å¡«å†™ï¼šæ€§èƒ½ç›¸å…³éœ€æ±‚]

### å®‰å…¨è¦æ±‚
- [å¡«å†™ï¼šå®‰å…¨ç›¸å…³éœ€æ±‚]

### å…¼å®¹æ€§è¦æ±‚
- [å¡«å†™ï¼šå…¼å®¹æ€§ç›¸å…³éœ€æ±‚]

---

## ä¾èµ–å…³ç³»

- [å¡«å†™ï¼šåˆ—å‡ºä¸å…¶ä»–åŠŸèƒ½çš„ä¾èµ–]

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0.0*
*åˆ›å»ºæ—¶é—´: [å½“å‰æ—¶é—´]*
\`\`\`

---

### æ–‡ä»¶ 2: design.md

**æ–‡ä»¶è·¯å¾„**: \`{docs_dir}/specs/{feature_name}/design.md\`

**æ–‡ä»¶å†…å®¹**ï¼ˆè¯·å°†ä»¥ä¸‹æ¨¡æ¿ä¿å­˜ä¸ºè¯¥æ–‡ä»¶ï¼Œå¹¶æ ¹æ®åŠŸèƒ½æè¿°å’Œé¡¹ç›®ä¸Šä¸‹æ–‡æ™ºèƒ½å¡«å……æ ‡è®°ä¸º [å¡«å†™] çš„éƒ¨åˆ†ï¼‰:

\`\`\`markdown
# è®¾è®¡æ–‡æ¡£ï¼š{feature_name}

## æ¦‚è¿°

{description}

æœ¬è®¾è®¡æ–‡æ¡£æè¿° {feature_name} åŠŸèƒ½çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆã€‚

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æŠ€æœ¯é€‰å‹

| ç±»åˆ« | é€‰æ‹© | ç†ç”± |
|------|------|------|
| [å¡«å†™ï¼šç±»åˆ«] | [å¡«å†™ï¼šæŠ€æœ¯] | [å¡«å†™ï¼šé€‰æ‹©ç†ç”±] |

### æ¶æ„è®¾è®¡

[å¡«å†™ï¼šæè¿°åŠŸèƒ½çš„æ¶æ„è®¾è®¡ï¼Œå‚è€ƒé¡¹ç›®ç°æœ‰æ¶æ„]

\\\`\\\`\\\`
[å¡«å†™ï¼šæ¶æ„å›¾æˆ–æµç¨‹å›¾ï¼Œä½¿ç”¨ ASCII æˆ– Mermaid]
\\\`\\\`\\\`

---

## æ•°æ®æ¨¡å‹

[å¡«å†™ï¼šå¦‚æœåŠŸèƒ½æ¶‰åŠæ•°æ®å­˜å‚¨ï¼Œæè¿°æ•°æ®æ¨¡å‹]

### æ•°æ®ç»“æ„

\\\`\\\`\\\`typescript
interface [å¡«å†™ï¼šModelName] {
  [å¡«å†™ï¼šfield]: [å¡«å†™ï¼štype];
}
\\\`\\\`\\\`

---

## API è®¾è®¡

[å¡«å†™ï¼šå¦‚æœåŠŸèƒ½æ¶‰åŠ APIï¼Œæè¿° API è®¾è®¡]

### æ¥å£å®šä¹‰

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| [å¡«å†™ï¼šGET/POST/...] | [å¡«å†™ï¼š/path] | [å¡«å†™ï¼šæè¿°] |

---

## æ–‡ä»¶ç»“æ„

[å¡«å†™ï¼šæè¿°åŠŸèƒ½æ¶‰åŠçš„æ–‡ä»¶å’Œç›®å½•]

\\\`\\\`\\\`
[é¡¹ç›®ç›®å½•]/
â”œâ”€â”€ [å¡«å†™ï¼šæ–°å¢æ–‡ä»¶1]
â”œâ”€â”€ [å¡«å†™ï¼šæ–°å¢æ–‡ä»¶2]
â””â”€â”€ [å¡«å†™ï¼šä¿®æ”¹æ–‡ä»¶]
\\\`\\\`\\\`

### æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| [å¡«å†™ï¼šæ–‡ä»¶è·¯å¾„] | [å¡«å†™ï¼šç”¨é€”è¯´æ˜] |

---

## ä¾èµ–å…³ç³»

### æ–°å¢ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| [å¡«å†™ï¼šä¾èµ–å] | [å¡«å†™ï¼šç‰ˆæœ¬] | [å¡«å†™ï¼šç”¨é€”] |

### å†…éƒ¨ä¾èµ–

- [å¡«å†™ï¼šåˆ—å‡ºä¾èµ–çš„å†…éƒ¨æ¨¡å—]

---

## è®¾è®¡å†³ç­–

### å†³ç­– 1: [å¡«å†™ï¼šå†³ç­–æ ‡é¢˜]

**é—®é¢˜**: [å¡«å†™ï¼šæè¿°é¢ä¸´çš„é—®é¢˜]

**é€‰é¡¹**:
1. [å¡«å†™ï¼šé€‰é¡¹ A]: [å¡«å†™ï¼šæè¿°]
2. [å¡«å†™ï¼šé€‰é¡¹ B]: [å¡«å†™ï¼šæè¿°]

**å†³ç­–**: é€‰æ‹© [å¡«å†™ï¼šé€‰é¡¹]

**ç†ç”±**: [å¡«å†™ï¼šè§£é‡Šé€‰æ‹©çš„ç†ç”±]

---

## é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| [å¡«å†™ï¼šé£é™©æè¿°] | [å¡«å†™ï¼šé«˜/ä¸­/ä½] | [å¡«å†™ï¼šç¼“è§£æªæ–½] |

---

*è®¾è®¡ç‰ˆæœ¬: 1.0.0*
*åˆ›å»ºæ—¶é—´: [å½“å‰æ—¶é—´]*
\`\`\`

---

### æ–‡ä»¶ 3: tasks.md

**æ–‡ä»¶è·¯å¾„**: \`{docs_dir}/specs/{feature_name}/tasks.md\`

**æ–‡ä»¶å†…å®¹**ï¼ˆè¯·å°†ä»¥ä¸‹æ¨¡æ¿ä¿å­˜ä¸ºè¯¥æ–‡ä»¶ï¼Œå¹¶æ ¹æ®éœ€æ±‚å’Œè®¾è®¡æ™ºèƒ½ç”Ÿæˆä»»åŠ¡æ¸…å•ï¼‰:

\`\`\`markdown
# ä»»åŠ¡æ¸…å•ï¼š{feature_name}

## æ¦‚è¿°

å®ç° {feature_name} åŠŸèƒ½çš„ä»»åŠ¡åˆ†è§£ã€‚

---

## ä»»åŠ¡åˆ—è¡¨

### é˜¶æ®µ 1: å‡†å¤‡å·¥ä½œ

- [ ] 1.1 [å¡«å†™ï¼šä»»åŠ¡æ ‡é¢˜]
  - [å¡«å†™ï¼šå…·ä½“æ“ä½œè¯´æ˜]
  - _éœ€æ±‚: [å¡«å†™ï¼šå¯¹åº”çš„éœ€æ±‚ç¼–å·]_

- [ ] 1.2 [å¡«å†™ï¼šä»»åŠ¡æ ‡é¢˜]
  - [å¡«å†™ï¼šå…·ä½“æ“ä½œè¯´æ˜]
  - _éœ€æ±‚: [å¡«å†™ï¼šå¯¹åº”çš„éœ€æ±‚ç¼–å·]_

---

### é˜¶æ®µ 2: æ ¸å¿ƒå®ç°

- [ ] 2.1 [å¡«å†™ï¼šä»»åŠ¡æ ‡é¢˜]
  - [å¡«å†™ï¼šå…·ä½“æ“ä½œè¯´æ˜]
  - _éœ€æ±‚: [å¡«å†™ï¼šå¯¹åº”çš„éœ€æ±‚ç¼–å·]_

- [ ] 2.2 [å¡«å†™ï¼šä»»åŠ¡æ ‡é¢˜]
  - [å¡«å†™ï¼šå…·ä½“æ“ä½œè¯´æ˜]
  - ä¾èµ–: ä»»åŠ¡ 2.1
  - _éœ€æ±‚: [å¡«å†™ï¼šå¯¹åº”çš„éœ€æ±‚ç¼–å·]_

---

### é˜¶æ®µ 3: é›†æˆæµ‹è¯•

- [ ] 3.1 [å¡«å†™ï¼šä»»åŠ¡æ ‡é¢˜]
  - [å¡«å†™ï¼šå…·ä½“æ“ä½œè¯´æ˜]
  - _éœ€æ±‚: [å¡«å†™ï¼šå¯¹åº”çš„éœ€æ±‚ç¼–å·]_

---

## æ£€æŸ¥ç‚¹

- [ ] é˜¶æ®µ 1 å®Œæˆåï¼š[å¡«å†™ï¼šéªŒè¯å†…å®¹]
- [ ] é˜¶æ®µ 2 å®Œæˆåï¼š[å¡«å†™ï¼šéªŒè¯å†…å®¹]
- [ ] é˜¶æ®µ 3 å®Œæˆåï¼š[å¡«å†™ï¼šéªŒè¯å†…å®¹]

---

## æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| [å¡«å†™ï¼šæ–‡ä»¶è·¯å¾„] | æ–°å»º/ä¿®æ”¹ | [å¡«å†™ï¼šè¯´æ˜] |

---

## ä¾èµ–ä»»åŠ¡

- [å¡«å†™ï¼šåˆ—å‡ºä¾èµ–çš„å…¶ä»–ä»»åŠ¡æˆ–åŠŸèƒ½]

---

*ä»»åŠ¡ç‰ˆæœ¬: 1.0.0*
*åˆ›å»ºæ—¶é—´: [å½“å‰æ—¶é—´]*
\`\`\`

---

## âœ… å®Œæˆåæ£€æŸ¥

**è¯·ç¡®è®¤ä»¥ä¸‹æ–‡ä»¶å·²åˆ›å»º**:
- [ ] \`{docs_dir}/specs/{feature_name}/requirements.md\` - éœ€æ±‚æ–‡æ¡£å·²åˆ›å»º
- [ ] \`{docs_dir}/specs/{feature_name}/design.md\` - è®¾è®¡æ–‡æ¡£å·²åˆ›å»º
- [ ] \`{docs_dir}/specs/{feature_name}/tasks.md\` - ä»»åŠ¡æ¸…å•å·²åˆ›å»º

**å†…å®¹è´¨é‡æ£€æŸ¥**:

### requirements.md æ£€æŸ¥

- [ ] åŠŸèƒ½æ¦‚è¿°æ¸…æ™°æè¿°äº†åŠŸèƒ½ç›®çš„
- [ ] æœ¯è¯­å®šä¹‰å®Œæ•´
- [ ] æ¯ä¸ªéœ€æ±‚éƒ½æœ‰ç”¨æˆ·æ•…äº‹
- [ ] éªŒæ”¶æ ‡å‡†ä½¿ç”¨ EARS æ ¼å¼
- [ ] éåŠŸèƒ½éœ€æ±‚å·²è€ƒè™‘
- [ ] ä¾èµ–å…³ç³»å·²åˆ—å‡º

### design.md æ£€æŸ¥

- [ ] æŠ€æœ¯é€‰å‹æœ‰æ˜ç¡®ç†ç”±
- [ ] æ¶æ„è®¾è®¡ç¬¦åˆé¡¹ç›®ç°æœ‰æ¶æ„
- [ ] æ•°æ®æ¨¡å‹å®šä¹‰æ¸…æ™°ï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] API è®¾è®¡å®Œæ•´ï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] æ–‡ä»¶ç»“æ„æ¸…æ™°
- [ ] è®¾è®¡å†³ç­–æœ‰è®°å½•

### tasks.md æ£€æŸ¥

- [ ] ä»»åŠ¡åˆ†é˜¶æ®µåˆç†
- [ ] æ¯ä¸ªä»»åŠ¡æœ‰æ˜ç¡®ç›®æ ‡
- [ ] ä¾èµ–å…³ç³»æ­£ç¡®
- [ ] ä»»åŠ¡å…³è”äº†éœ€æ±‚
- [ ] æ£€æŸ¥ç‚¹å®Œæ•´
- [ ] æ–‡ä»¶å˜æ›´æ¸…å•å®Œæ•´

### é€šç”¨æ£€æŸ¥

- [ ] ä¸‰ä¸ªæ–‡ä»¶éƒ½å·²åˆ›å»º
- [ ] æ–‡ä»¶è·¯å¾„æ­£ç¡®: \`{docs_dir}/specs/{feature_name}/\`
- [ ] æ‰€æœ‰å ä½ç¬¦å·²æ›¿æ¢
- [ ] Markdown æ ¼å¼æ­£ç¡®
- [ ] å†…å®¹ä¸é¡¹ç›®ä¸Šä¸‹æ–‡ä¸€è‡´ï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **å‚è€ƒé¡¹ç›®ä¸Šä¸‹æ–‡**: å¦‚æœå­˜åœ¨ \`{docs_dir}/project-context.md\`ï¼Œè¯·å‚è€ƒå…¶ä¸­çš„æŠ€æœ¯æ ˆå’Œæ¶æ„ä¿¡æ¯
2. **ä¿æŒä¸€è‡´æ€§**: æ–‡æ¡£é£æ ¼åº”ä¸é¡¹ç›®ç°æœ‰æ–‡æ¡£ä¿æŒä¸€è‡´
3. **éœ€æ±‚å¯æµ‹è¯•**: æ¯ä¸ªéªŒæ”¶æ ‡å‡†éƒ½åº”è¯¥æ˜¯å¯æµ‹è¯•çš„
4. **ä»»åŠ¡å¯æ‰§è¡Œ**: æ¯ä¸ªä»»åŠ¡éƒ½åº”è¯¥æ˜¯å…·ä½“å¯æ‰§è¡Œçš„
5. **æ—¶é—´æ ¼å¼**: ä½¿ç”¨ YYYY-MM-DD HH:mm:ss æ ¼å¼

---

*æŒ‡å—ç‰ˆæœ¬: 1.0.0*
*å·¥å…·: MCP Probe Kit - add_feature*
`;

/**
 * add_feature å·¥å…·å®ç°
 * 
 * @param args - å·¥å…·å‚æ•°
 * @param args.feature_name - åŠŸèƒ½åç§°ï¼ˆå¿…å¡«ï¼Œkebab-case æ ¼å¼ï¼‰
 * @param args.description - åŠŸèƒ½æè¿°ï¼ˆå¿…å¡«ï¼‰
 * @param args.docs_dir - æ–‡æ¡£ç›®å½•ï¼Œé»˜è®¤ "docs"
 * @returns MCP å“åº”ï¼ŒåŒ…å«åŠŸèƒ½è§„æ ¼ç”ŸæˆæŒ‡å—
 */
export async function addFeature(args: any) {
  try {
    // æ™ºèƒ½å‚æ•°è§£æï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€è¾“å…¥
    const parsedArgs = parseArgs<{
      feature_name?: string;
      description?: string;
      docs_dir?: string;
      input?: string;
    }>(args, {
      defaultValues: {
        feature_name: "",
        description: "",
        docs_dir: DEFAULT_DOCS_DIR,
      },
      primaryField: "input", // çº¯æ–‡æœ¬è¾“å…¥é»˜è®¤æ˜ å°„åˆ° input å­—æ®µ
      fieldAliases: {
        feature_name: ["name", "feature", "åŠŸèƒ½å", "åŠŸèƒ½åç§°"],
        description: ["desc", "requirement", "æè¿°", "éœ€æ±‚"],
        docs_dir: ["dir", "output", "ç›®å½•", "æ–‡æ¡£ç›®å½•"],
      },
    });

    let featureName = getString(parsedArgs.feature_name);
    let description = getString(parsedArgs.description);
    const docsDir = getString(parsedArgs.docs_dir) || DEFAULT_DOCS_DIR;

    // å¦‚æœæ˜¯çº¯è‡ªç„¶è¯­è¨€è¾“å…¥ï¼ˆinput å­—æ®µæœ‰å€¼ä½† feature_name å’Œ description ä¸ºç©ºï¼‰
    const input = getString(parsedArgs.input);
    if (input && !featureName && !description) {
      // æ™ºèƒ½æå–åŠŸèƒ½åå’Œæè¿°
      // å°è¯•ä»è‡ªç„¶è¯­è¨€ä¸­æå–åŠŸèƒ½åï¼ˆé€šå¸¸æ˜¯å…³é”®è¯ï¼‰
      const extracted = extractFeatureInfo(input);
      featureName = extracted.name;
      description = extracted.description;
    }

    // å¦‚æœåªæœ‰ description æ²¡æœ‰ feature_nameï¼Œå°è¯•ä» description æå–
    if (!featureName && description) {
      const extracted = extractFeatureInfo(description);
      featureName = extracted.name;
      if (!description || description === featureName) {
        description = extracted.description;
      }
    }

    // éªŒè¯å¿…å¡«å‚æ•°
    if (!featureName || !description) {
      throw new Error(
        "è¯·æä¾›åŠŸèƒ½åç§°å’Œæè¿°ã€‚\n\n" +
        "ç¤ºä¾‹ç”¨æ³•ï¼š\n" +
        "- è‡ªç„¶è¯­è¨€ï¼š'æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½'\n" +
        "- è¯¦ç»†æè¿°ï¼š'å®ç°ç”¨æˆ·ç™»å½•ã€æ³¨å†Œå’Œå¯†ç é‡ç½®åŠŸèƒ½'\n" +
        "- JSONæ ¼å¼ï¼š{\"feature_name\": \"user-auth\", \"description\": \"ç”¨æˆ·è®¤è¯åŠŸèƒ½\"}"
      );
    }

    // æ„å»ºæŒ‡å—æ–‡æœ¬ï¼ˆæ›¿æ¢å ä½ç¬¦ï¼‰
    const guide = PROMPT_TEMPLATE
      .replace(/{feature_name}/g, featureName)
      .replace(/{description}/g, description)
      .replace(/{docs_dir}/g, docsDir);

    // åˆ›å»ºç»“æ„åŒ–æ•°æ®å¯¹è±¡
    const structuredData: FeatureSpec = {
      summary: `æ·»åŠ åŠŸèƒ½ï¼š${featureName}`,
      featureName: featureName,
      requirements: [
        "å¾…ç”Ÿæˆéœ€æ±‚æ–‡æ¡£",
        "ä½¿ç”¨ EARS æ ¼å¼ç¼–å†™éªŒæ”¶æ ‡å‡†"
      ],
      design: {
        architecture: "å¾…è®¾è®¡",
        components: [],
        dataFlow: "å¾…è®¾è®¡"
      },
      tasks: [
        {
          id: "1",
          title: "ç”Ÿæˆéœ€æ±‚æ–‡æ¡£",
          description: `åˆ›å»º ${docsDir}/specs/${featureName}/requirements.md`,
          estimatedHours: 1
        },
        {
          id: "2",
          title: "ç”Ÿæˆè®¾è®¡æ–‡æ¡£",
          description: `åˆ›å»º ${docsDir}/specs/${featureName}/design.md`,
          estimatedHours: 2
        },
        {
          id: "3",
          title: "ç”Ÿæˆä»»åŠ¡æ¸…å•",
          description: `åˆ›å»º ${docsDir}/specs/${featureName}/tasks.md`,
          estimatedHours: 1
        }
      ],
      estimate: {
        storyPoints: 0,
        optimistic: "å¾…ä¼°ç®—",
        normal: "å¾…ä¼°ç®—",
        pessimistic: "å¾…ä¼°ç®—"
      }
    };

    return okStructured(guide, structuredData, {
      schema: (await import("../schemas/output/project-tools.js")).FeatureSpecSchema,
    });
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    
    const errorData: FeatureSpec = {
      summary: "æ·»åŠ åŠŸèƒ½å¤±è´¥",
      featureName: "",
      requirements: [],
      tasks: []
    };
    
    return okStructured(`âŒ æ·»åŠ åŠŸèƒ½å¤±è´¥: ${errorMessage}`, errorData, {
      schema: (await import("../schemas/output/project-tools.js")).FeatureSpecSchema,
    });
  }
}
